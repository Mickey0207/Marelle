import{r as n,j as e,A as s}from"./index-09c3368c.js";import{S as m}from"./SearchableSelect-bf34f521.js";import{S as U}from"./StandardTable-d1cd024c.js";import{s as M}from"./supplierDataManager-ea137c91.js";import{G as I}from"./GlassModal-a6c5f610.js";import{I as B}from"./IconActionButton-fd764fa6.js";import{P as Y}from"./PlusIcon-3d2e3b30.js";import{M as q}from"./MagnifyingGlassIcon-0e31f702.js";import{E as H}from"./EyeIcon-bb65ea7b.js";import{P as J}from"./PencilIcon-619ae986.js";import{D as K}from"./DocumentTextIcon-57b6349a.js";import"./chevron-down-5d12351e.js";import"./XMarkIcon-93d59038.js";const R=["draft","pending","approved","confirmed","production","shipped","delivered","completed","cancelled"],L=["low","normal","high","urgent","critical"],X=Array.from({length:36}).map((b,c)=>({id:`PO-${2e3+c}`,supplierId:`SUP-${1e3+c%12}`,supplierName:`示範供應商 ${c%12+1}`,status:R[c%R.length],priority:L[c%L.length],totalAmount:Math.floor(Math.random()*5e5)+5e4,expectedDeliveryDate:new Date(Date.now()+c%10*864e5).toISOString().slice(0,10),createdAt:new Date(Date.now()-c*864e5).toISOString().slice(0,10),notes:""})),w={getPurchaseOrders(b={}){const{status:c,search:g}=b;let u=[...X];if(c&&(u=u.filter(i=>i.status===c)),g){const i=String(g).toLowerCase();u=u.filter(v=>String(v.id).toLowerCase().includes(i)||String(v.supplierName).toLowerCase().includes(i))}return u}},pe=()=>{const[b,c]=n.useState([]),[g,u]=n.useState(!0),[i,v]=n.useState({status:"all",priority:"all",searchQuery:""}),[T,y]=n.useState(!1),[F,j]=n.useState(!1),[Q,f]=n.useState(!1),[r,k]=n.useState(null),[p,h]=n.useState({status:"",priority:"",expectedDeliveryDate:"",notes:""}),[l,o]=n.useState({supplierId:"",supplierName:"",type:"standard",priority:"normal",totalAmount:"",taxRate:.05,expectedDeliveryDate:"",notes:""}),[N,O]=n.useState([]),[D,S]=n.useState(!1),C=n.useCallback(async()=>{u(!0);try{const t={};i.status!=="all"&&(t.status=i.status),i.searchQuery&&(t.search=i.searchQuery);const a=w.getPurchaseOrders(t)||[],d=i.priority==="all"?a:a.filter(x=>x.priority===i.priority);c(d)}catch(t){console.error("Error loading procurement data:",t)}finally{u(!1)}},[i]);n.useEffect(()=>{C()},[i,C]),n.useEffect(()=>{try{const a=((M.getAllSuppliers?M.getAllSuppliers():[])||[]).map(d=>({value:d.id,label:d.companyName}));O(a)}catch(t){console.warn("載入供應商失敗或未提供供應商管理器",t),O([])}},[]);const A=t=>{const a={draft:s.statusInactive,pending:s.statusPending,approved:s.statusInfo,confirmed:s.statusSuccess,production:s.statusWarning,shipped:s.statusInfo,delivered:s.statusSuccess,completed:s.statusSuccess,cancelled:s.statusError},d={draft:"草稿",pending:"待審核",approved:"已核准",confirmed:"已確認",production:"生產中",shipped:"已出貨",delivered:"已送達",completed:"已完成",cancelled:"已取消"},x=a[t]||s.statusInactive;return e.jsx("span",{className:x,children:d[t]||t})},$=t=>{const a={low:"bg-gray-100 text-gray-800",normal:"bg-blue-100 text-blue-800",high:"bg-orange-100 text-orange-800",urgent:"bg-red-100 text-red-800",critical:"bg-red-100 text-red-800"},d={low:"低",normal:"一般",high:"高",urgent:"緊急",critical:"關鍵"},x=a[t]||"bg-gray-100 text-gray-800";return e.jsx("span",{className:`px-2.5 py-0.5 rounded-full text-xs font-medium ${x}`,children:d[t]||t})},W=t=>{k(t),y(!0)},E=t=>{k(t),h({status:t.status||"draft",priority:t.priority||"normal",expectedDeliveryDate:t.expectedDeliveryDate||"",notes:t.notes||""}),j(!0)},_=async()=>{if(r){S(!0);try{w.updatePurchaseOrder(r.id,{status:p.status,priority:p.priority,expectedDeliveryDate:p.expectedDeliveryDate,notes:p.notes}),await C(),j(!1)}catch(t){console.error("更新失敗",t)}finally{S(!1)}}},G=async()=>{var t;if(!l.supplierId&&!l.supplierName){alert("請選擇或輸入供應商");return}S(!0);try{const a=Number(l.totalAmount)||0,d=Number(l.taxRate)||0,x=Math.round(a*(1+d)),V={supplierId:l.supplierId||void 0,supplierName:l.supplierName||((t=N.find(z=>z.value===l.supplierId))==null?void 0:t.label)||"",type:l.type,priority:l.priority,totalAmount:a,taxRate:d,totalWithTax:x,expectedDeliveryDate:l.expectedDeliveryDate||"",notes:l.notes||""},P=w.createPurchaseOrder(V);await C(),f(!1),P&&(k(P),y(!0)),o({supplierId:"",supplierName:"",type:"standard",priority:"normal",totalAmount:"",taxRate:.05,expectedDeliveryDate:"",notes:""})}catch(a){console.error("建立失敗",a)}finally{S(!1)}};return g?e.jsx("div",{className:"bg-[#fdf8f2] min-h-screen p-6",children:e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#cc824d]"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"載入採購數據中..."})]})}):e.jsxs("div",{className:"bg-[#fdf8f2] min-h-screen p-6",children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 font-chinese",children:"採購管理"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"管理所有採購訂單和供應商關係"})]}),e.jsx("div",{children:e.jsxs("button",{className:`${s.primaryButton} inline-flex items-center`,onClick:()=>f(!0),children:[e.jsx(Y,{className:"w-5 h-5 mr-2"})," 新增採購單"]})})]}),e.jsx("div",{className:`${s.glassCard} mb-6`,children:e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsx("div",{className:"col-span-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(q,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"}),e.jsx("input",{type:"text",placeholder:"搜尋採購單號、供應商...",value:i.searchQuery,onChange:t=>v(a=>({...a,searchQuery:t.target.value})),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#cc824d] focus:border-transparent"})]})}),e.jsx("div",{children:e.jsx(m,{placeholder:"篩選狀態",value:i.status,onChange:t=>v(a=>({...a,status:t})),options:[{value:"all",label:"所有狀態"},{value:"draft",label:"草稿"},{value:"pending",label:"待審核"},{value:"approved",label:"已核准"},{value:"confirmed",label:"已確認"},{value:"production",label:"生產中"},{value:"shipped",label:"已出貨"},{value:"delivered",label:"已送達"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}],size:"sm"})}),e.jsx("div",{children:e.jsx(m,{placeholder:"優先級",value:i.priority,onChange:t=>v(a=>({...a,priority:t})),options:[{value:"all",label:"所有優先級"},{value:"low",label:"低"},{value:"normal",label:"一般"},{value:"high",label:"高"},{value:"urgent",label:"緊急"},{value:"critical",label:"關鍵"}]})}),e.jsx("div",{})]})}),e.jsx(U,{title:"採購訂單",data:b,columns:[{key:"poNumber",label:"採購單號",sortable:!0},{key:"supplierName",label:"供應商",sortable:!0},{key:"type",label:"類型",sortable:!0,render:t=>e.jsx("span",{className:"px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:t})},{key:"status",label:"狀態",sortable:!0,render:t=>A(t)},{key:"priority",label:"優先級",sortable:!0,render:t=>$(t)},{key:"totalWithTax",label:"總金額(含稅)",sortable:!0,render:(t,a)=>e.jsx("span",{className:"text-gray-900",children:(t??a.totalAmount??0).toLocaleString()})},{key:"expectedDeliveryDate",label:"預計交期",sortable:!0},{key:"createdAt",label:"建立時間",sortable:!0},{key:"actions",label:"操作",sortable:!1,render:(t,a)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{Icon:H,label:"檢視",variant:"blue",onClick:()=>W(a)}),e.jsx(B,{Icon:J,label:"編輯",variant:"amber",onClick:()=>E(a)})]})}],showExport:!0,exportFileName:"採購訂單",emptyIcon:K,emptyTitle:"沒有找到採購訂單",emptyDescription:"請調整篩選條件或稍後再試",enableBatchSelection:!1}),e.jsx(I,{isOpen:Q,onClose:()=>f(!1),title:"新增採購單",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"供應商"}),N.length>0?e.jsx(m,{placeholder:"選擇供應商",value:l.supplierId||"custom",onChange:t=>{o(t==="custom"?a=>({...a,supplierId:"",supplierName:""}):a=>({...a,supplierId:t,supplierName:""}))},options:[{value:"custom",label:"手動輸入供應商名稱"},...N]}):e.jsx("input",{type:"text",className:s.input,placeholder:"輸入供應商名稱",value:l.supplierName,onChange:t=>o(a=>({...a,supplierName:t.target.value}))}),N.length>0&&!l.supplierId&&e.jsx("input",{type:"text",className:`${s.input} mt-2`,placeholder:"或輸入供應商名稱",value:l.supplierName,onChange:t=>o(a=>({...a,supplierName:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"類型"}),e.jsx(m,{value:l.type,onChange:t=>o(a=>({...a,type:t})),options:[{value:"standard",label:"一般"},{value:"urgent",label:"緊急"},{value:"planned",label:"預定"},{value:"sample",label:"樣品"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"優先級"}),e.jsx(m,{value:l.priority,onChange:t=>o(a=>({...a,priority:t})),options:[{value:"low",label:"低"},{value:"normal",label:"一般"},{value:"high",label:"高"},{value:"urgent",label:"緊急"},{value:"critical",label:"關鍵"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"預計交期"}),e.jsx("input",{type:"date",className:s.input,value:l.expectedDeliveryDate,onChange:t=>o(a=>({...a,expectedDeliveryDate:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"金額（未稅）"}),e.jsx("input",{type:"number",min:"0",className:s.input,placeholder:"例如 50000",value:l.totalAmount,onChange:t=>o(a=>({...a,totalAmount:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"稅率"}),e.jsx(m,{value:String(l.taxRate),onChange:t=>o(a=>({...a,taxRate:Number(t)})),options:[{value:"0",label:"0%"},{value:"0.05",label:"5%"},{value:"0.1",label:"10%"}]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"備註"}),e.jsx("textarea",{className:`${s.input} min-h-[100px]`,value:l.notes,onChange:t=>o(a=>({...a,notes:t.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:s.secondaryButton,onClick:()=>f(!1),children:"取消"}),e.jsx("button",{className:`${s.primaryButton} ${D?"opacity-70 pointer-events-none":""}`,onClick:G,children:D?"建立中…":"建立採購單"})]})]})}),e.jsx(I,{isOpen:T&&!!r,onClose:()=>y(!1),title:r?`檢視採購單 ${r.poNumber}`:"檢視採購單",children:r&&e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"採購單號"}),e.jsx("div",{className:"font-medium",children:r.poNumber})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"供應商"}),e.jsx("div",{className:"font-medium",children:r.supplierName})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"狀態"}),e.jsx("div",{className:"font-medium",children:A(r.status)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"優先級"}),e.jsx("div",{className:"font-medium",children:$(r.priority)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"總金額(含稅)"}),e.jsx("div",{className:"font-medium",children:(r.totalWithTax??r.totalAmount??0).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"預計交期"}),e.jsx("div",{className:"font-medium",children:r.expectedDeliveryDate||"-"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500",children:"建立時間"}),e.jsx("div",{className:"font-medium",children:r.createdAt})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-500 mb-1",children:"備註"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-line",children:r.notes||"—"})]}),e.jsx("div",{className:"px-0 pt-2",children:e.jsx("button",{className:s.primaryButton,onClick:()=>{y(!1),E(r)},children:"編輯此採購單"})})]})}),e.jsx(I,{isOpen:F&&!!r,onClose:()=>j(!1),title:r?`編輯採購單 ${r.poNumber}`:"編輯採購單",children:r&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"狀態"}),e.jsx(m,{value:p.status,onChange:t=>h(a=>({...a,status:t})),options:[{value:"draft",label:"草稿"},{value:"pending",label:"待審核"},{value:"approved",label:"已核准"},{value:"confirmed",label:"已確認"},{value:"production",label:"生產中"},{value:"ready",label:"準備出貨"},{value:"shipped",label:"已出貨"},{value:"delivered",label:"已送達"},{value:"inspecting",label:"驗收中"},{value:"completed",label:"已完成"},{value:"cancelled",label:"已取消"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"優先級"}),e.jsx(m,{value:p.priority,onChange:t=>h(a=>({...a,priority:t})),options:[{value:"low",label:"低"},{value:"normal",label:"一般"},{value:"high",label:"高"},{value:"urgent",label:"緊急"},{value:"critical",label:"關鍵"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"預計交期"}),e.jsx("input",{type:"date",className:s.input,value:p.expectedDeliveryDate||"",onChange:t=>h(a=>({...a,expectedDeliveryDate:t.target.value}))})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"備註"}),e.jsx("textarea",{className:`${s.input} min-h-[100px]`,value:p.notes,onChange:t=>h(a=>({...a,notes:t.target.value}))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{className:s.secondaryButton,onClick:()=>j(!1),children:"取消"}),e.jsx("button",{className:`${s.primaryButton} ${D?"opacity-70 pointer-events-none":""}`,onClick:_,children:D?"儲存中…":"儲存變更"})]})]})})]})};export{pe as default};
