import{r as a,j as e,A as n}from"./index-5be64975.js";import{G as V}from"./GlassModal-8d9cbd14.js";import{T as X}from"./TabNavigation-b0ee78ba.js";import{S as _}from"./SearchableSelect-06cd3eb3.js";import{r as ve,b as ye,V as R,g as Ne,a as we,c as Se}from"./presets-f50821a2.js";import"./XMarkIcon-404a829f.js";import"./chevron-down-e41c1b61.js";function Ce(){return"【Marelle】嗨 {{ user.name }}，您的訂單 {{ order.id }} 已出貨。查詢碼：{{ shipment.tracking }}"}const ee="__mock_sms_text_templates__";function y(){try{return JSON.parse(localStorage.getItem(ee)||"[]")}catch{return[]}}function T(d){localStorage.setItem(ee,JSON.stringify(d))}function v(){return y()}function ke(d){const c=String(d||"").toLowerCase();return y().filter(m=>(m.name||"").toLowerCase().includes(c)||(m.description||"").toLowerCase().includes(c))}function Pe(d){const c=y(),m={id:`SM-${Date.now()}`,name:"",description:"",category:"",tags:[],content:Ce(),...d};return c.unshift(m),T(c),m}function Te(d,c){const m=y().map(h=>h.id===d?{...h,...c,updatedAt:Date.now()}:h);T(m)}function $e(d){const c=y().filter(m=>m.id!==d);T(c)}function Ae(d){const c=y(),m=c.find(j=>j.id===d);if(!m)return null;const h={...m,id:`SM-${Date.now()}`,name:`${m.name||"未命名"} (複製)`,updatedAt:Date.now()};return c.unshift(h),T(c),h}function Z(d,c){return ve(d||"",c)}const _e=()=>{const d=({content:t="",from:s="Marelle"})=>{const l=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=t!=null&&t.trim()?t:"（尚未輸入內容）";return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"mx-auto w-full max-w-[320px] rounded-[36px] border border-gray-300 bg-white shadow relative overflow-hidden",children:[e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 top-0 h-6 w-32 bg-black/10 rounded-b-2xl"}),e.jsx("div",{className:"pt-6"}),e.jsx("div",{className:"px-4 py-2 border-b border-gray-200 text-center text-sm font-medium text-gray-800",children:"訊息"}),e.jsx("div",{className:"bg-gray-100 h-[480px] overflow-y-auto p-3 space-y-2",children:e.jsx("div",{className:"flex items-end gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"inline-block bg-white text-gray-900 px-3 py-2 rounded-2xl rounded-tl-sm shadow whitespace-pre-wrap max-w-[85%]",children:p}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:l})]})})}),e.jsx("div",{className:"bg-white border-t border-gray-200 px-3 py-2 text-gray-400 text-sm",children:"簡訊輸入列（預覽）"})]})})},[c,m]=a.useState(""),[h,j]=a.useState(null),[w,b]=a.useState([]),[o,g]=a.useState({name:"",category:"",description:"",tags:[],content:""}),[I,G]=a.useState(!1),F=a.useRef(null),[te,S]=a.useState(!1),[se,$]=a.useState(!1),[A,E]=a.useState(!1),[C,K]=a.useState(()=>ye()),[W,q]=a.useState("default"),[N,ae]=a.useState("preview"),[z,J]=a.useState(!1),[M,Y]=a.useState(null),[B,ne]=a.useState(R[0].key),[H,le]=a.useState(""),D=a.useMemo(()=>Ne(),[]),Q=a.useMemo(()=>{const t=[];Object.entries(D).forEach(([l,p])=>{(p||[]).forEach(x=>{const f=(x.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...x,category:l,path:f})})});const s=Object.fromEntries(t.map(l=>[l.path,l])),r=Object.fromEntries(t.map(l=>[l.token,l]));return{items:t,byPath:s,byToken:r}},[D]),O=a.useMemo(()=>{const t=(o==null?void 0:o.content)||"",s=/\{\{\s*([\w.]+)\s*\}\}/g,r=new Set;let l;for(;l=s.exec(t);)l[1]&&r.add(l[1]);return Array.from(r)},[o==null?void 0:o.content]),k=a.useMemo(()=>O.length?O.map(t=>{const s=Q.byPath[t];if(s)return s;const r=t.split(".")[0];return{label:t,token:`{{${t}}}`,desc:"",category:r,path:t}}):[],[O,Q.byPath]),ie=(t,s)=>s.split(".").reduce((r,l)=>r&&r[l]!==void 0?r[l]:"",t),re=(t,s,r)=>{const l=s.split("."),p=Array.isArray(t)?[...t]:{...t};let x=p;for(let f=0;f<l.length;f++){const u=l[f];if(f===l.length-1)x[u]=r;else{const P=x[u],be=P&&typeof P=="object"&&!Array.isArray(P);x[u]=be?{...P}:{},x=x[u]}}return p},ce=a.useMemo(()=>{const t=k.length;return N==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[N,k.length]);a.useEffect(()=>{const t=v();b(t),t.length&&j(t[0].id)},[]);const i=a.useMemo(()=>w.find(t=>t.id===h)||null,[w,h]);a.useEffect(()=>{g(i?{name:i.name||"",category:i.category||"",description:i.description||"",tags:Array.isArray(i.tags)?i.tags:[],content:i.content||""}:{name:"",category:"",description:"",tags:[],content:""})},[i]);const U=a.useMemo(()=>c?ke(c):w,[c,w]),oe=()=>{const t=Pe({name:"新簡訊範本",description:""}),s=v();b(s),j(t.id)},de=t=>{const s=Ae(t),r=v();b(r),s&&j(s.id)},me=t=>{b(v())},xe=()=>{var s;if(!i)return;$e(i.id);const t=v();b(t),j(((s=t[0])==null?void 0:s.id)||null),S(!1)},ue=()=>{i&&(G(!0),Te(i.id,{...o}),b(v()),G(!1))},he=t=>{const s=F.current;if(!s){g(u=>({...u,content:(u.content||"")+t}));return}const r=s.selectionStart??s.value.length,l=s.selectionEnd??s.value.length,p=o.content.slice(0,r),x=o.content.slice(l),f=`${p}${t}${x}`;g(u=>({...u,content:f})),requestAnimationFrame(()=>{s.focus();const u=r+t.length;s.setSelectionRange(u,u)})},[pe,ge]=a.useState({phone:""}),fe=()=>{J(!0),Y(null);const t=Z(o.content,C);setTimeout(()=>{J(!1),Y({success:!0,message:"測試簡訊已模擬送出",rendered:t})},700)},je=we(),L=t=>{K(Se(t))};return a.useEffect(()=>{A&&L(W||"default")},[A]),e.jsxs("div",{className:`${n.pageContainer}`,children:[e.jsxs("div",{className:`${n.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:n.pageTitle,children:"SMS"}),e.jsx("p",{className:n.pageSubtitle,children:"集中管理簡訊文字範本"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:n.secondaryButton,onClick:()=>i&&de(i.id),children:"複製範本"}),e.jsx("button",{className:n.primaryButton,onClick:oe,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${n.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、標籤",value:c,onChange:t=>m(t.target.value),className:`${n.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[U.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),U.map(t=>e.jsx("button",{onClick:()=>j(t.id),className:`w-full text-left p-4 transition-colors ${h===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500 line-clamp-1",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${n.glassCard} space-y-6`,children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:n.input,value:o.name,onChange:t=>g(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(_,{options:[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],value:o.category,onChange:t=>g(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:n.input,value:o.description,onChange:t=>g(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(_,{options:[{label:"otp",value:"otp"},{label:"order",value:"order"},{label:"logistics",value:"logistics"},{label:"promo",value:"promo"},{label:"notice",value:"notice"}],value:o.tags,onChange:t=>g(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:n.btnGhost,onClick:()=>$(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:F,className:`${n.input} min-h-[160px]`,value:o.content,onChange:t=>g(s=>({...s,content:t.target.value})),placeholder:"輸入簡訊內容（70/160 字限制視編碼與長簡訊拆分）"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",i.updatedAt?new Date(i.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:n.btnSecondary,onClick:()=>S(!0),children:"刪除"}),i.status!=="published"&&e.jsx("button",{className:n.btnGhost,onClick:()=>me(i.id),children:"發佈"}),e.jsx("button",{className:n.btnGhost,onClick:()=>E(!0),children:"預覽"}),e.jsx("button",{className:`${n.btnPrimary} ${I?"opacity-70 pointer-events-none":""}`,onClick:ue,children:I?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(V,{isOpen:te,onClose:()=>S(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",i==null?void 0:i.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:n.secondaryButton,onClick:()=>S(!1),children:"取消"}),e.jsx("button",{className:n.primaryButton,onClick:xe,children:"確定刪除"})]})]})}),e.jsx(V,{isOpen:A,onClose:()=>E(!1),title:"預覽",size:ce,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(X,{mode:"controlled",activeKey:N,onTabChange:t=>ae(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽與發送"},{key:"context",label:"情境與欄位"}]}),N==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-6",children:e.jsx(d,{content:Z(o.content,C)})}),e.jsxs("div",{className:"col-span-6",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"發送測試"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"測試收件者（手機號碼）"}),e.jsx("input",{className:n.input,value:pe.phone,onChange:t=>ge(s=>({...s,phone:t.target.value})),placeholder:"09xx-xxx-xxx"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"不會真正發送簡訊，只做本地模擬"}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:`${n.primaryButton} ${z?"opacity-70 pointer-events-none":""}`,onClick:fe,children:z?"傳送中…":"送出測試"})}),M&&e.jsx("div",{className:`${M.success?"text-green-700 bg-green-50":"text-red-700 bg-red-50"} p-3 rounded-lg text-sm`,children:M.message})]})]})]}),N==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(_,{options:je,value:W,onChange:t=>{q(t),L(t)},placeholder:"選擇情境"})]}),k.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:k.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),r=ie(C,t.path),l=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:l}),e.jsx("input",{className:n.input,value:r||"",disabled:s,onChange:p=>{const x=re(C,t.path,p.target.value);K(x)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:n.secondaryButton,onClick:()=>{q("default"),L("default")},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:n.primaryButton,onClick:()=>E(!1),children:"關閉"})})]})}),e.jsx(V,{isOpen:se,onClose:()=>$(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(X,{mode:"controlled",activeKey:B,onTabChange:t=>ne(t.key),layout:"left",tabs:R.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:H,onChange:t=>le(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${n.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(R.find(t=>t.key===B)?D[B]:[]).filter(t=>{const s=H.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(r=>r.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsx("button",{className:n.primaryButton,onClick:()=>he(t.token),children:"插入"})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:n.secondaryButton,onClick:()=>$(!1),children:"完成"})})]})})]})};export{_e as default};
