import{r as n,j as e,A as a}from"./index-5be64975.js";import{G as I}from"./GlassModal-8d9cbd14.js";import{T as le}from"./TabNavigation-b0ee78ba.js";import{S as z}from"./SearchableSelect-06cd3eb3.js";import{r as ne,b as Te,V as F,g as Me,a as Ae,c as K}from"./presets-f50821a2.js";import"./XMarkIcon-404a829f.js";import"./chevron-down-e41c1b61.js";function Ee(){return`<div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; line-height:1.7; color:#111;">
  <h2 style="margin:0 0 12px; font-size:20px;">嗨 {{ user.name }}，</h2>
  <p style="margin:0 0 12px;">您的訂單 <strong>{{ order.id }}</strong> 已出貨 🎉</p>
  <p style="margin:0 0 12px;">歡迎回到我們的商店逛逛最新商品與優惠：</p>
  <p style="margin:0 0 16px;"><a href="https://marelle.com.tw" style="background:#cc824d;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;">前往 Marelle</a></p>
  <hr style="border:none;border-top:1px solid #e5e7eb; margin:16px 0;"/>
  <p style="margin:0; font-size:12px; color:#6b7280;">若有任何問題，隨時聯繫我們的客服。</p>
</div>`}const ie="__mock_mail_html_templates__";function w(){try{return JSON.parse(localStorage.getItem(ie)||"[]")}catch{return[]}}function $(u){localStorage.setItem(ie,JSON.stringify(u))}function N(){return w()}function Pe(u){const o=String(u||"").toLowerCase();return w().filter(d=>(d.name||"").toLowerCase().includes(o)||(d.description||"").toLowerCase().includes(o)||(d.subject||"").toLowerCase().includes(o))}function $e(u){const o=w(),d={id:`MH-${Date.now()}`,name:"",description:"",category:"",tags:[],subject:"Marelle 最新優惠與通知",html:Ee(),...u};return o.unshift(d),$(o),d}function Le(u,o){const d=w().map(p=>p.id===u?{...p,...o,updatedAt:Date.now()}:p);$(d)}function He(u){const o=w().filter(d=>d.id!==u);$(o)}function Be(u){const o=w(),d=o.find(y=>y.id===u);if(!d)return null;const p={...d,id:`MH-${Date.now()}`,name:`${d.name||"未命名"} (複製)`,updatedAt:Date.now()};return o.unshift(p),$(o),p}function re({subject:u,html:o},d){return{subject:ne(u||"",d),html:ne(o||"",d)}}const ze=()=>{const u=({subject:t="",html:s=""})=>{const r=(x=>{try{const m=["a","p","div","span","strong","b","em","i","u","h1","h2","h3","h4","h5","h6","ul","ol","li","br","hr","img","table","thead","tbody","tr","td","th"],g=["href","style","src","alt","width","height","target","rel"],f=new DOMParser().parseFromString(x,"text/html"),j=h=>{if(h.nodeType===1){const Se=h.tagName.toLowerCase();if(!m.includes(Se)){h.replaceWith(...Array.from(h.childNodes));return}Array.from(h.attributes).forEach(P=>{const G=P.name.toLowerCase();g.includes(G)||h.removeAttribute(P.name),(G==="href"||G==="src")&&/javascript:/i.test(P.value)&&h.removeAttribute(P.name)})}Array.from(h.childNodes).forEach(j)};return j(f.body),f.body.innerHTML}catch{return x}})(s);return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"w-full max-w-3xl rounded-2xl border border-gray-200 overflow-hidden bg-white shadow",children:[e.jsx("div",{className:"bg-gray-800 text-white px-4 py-2 text-sm font-medium",children:"Email HTML 預覽"}),e.jsxs("div",{className:"p-5 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-900 break-words",children:t||"（無主旨）"}),e.jsx("div",{className:"h-px bg-gray-200"}),e.jsx("div",{className:"prose prose-sm max-w-none",dangerouslySetInnerHTML:{__html:r||'<p class="text-gray-400">（尚未輸入 HTML 內容）</p>'}})]})]})})},[o,d]=n.useState(""),[p,y]=n.useState(null),[C,v]=n.useState([]),[i,b]=n.useState({name:"",category:"",description:"",tags:[],subject:"",html:""}),[W,q]=n.useState(!1),L=n.useRef(null),J=n.useRef(null),[ce,S]=n.useState(!1),[oe,T]=n.useState(!1),[H,B]=n.useState(!1),[M,A]=n.useState(()=>Te()),[Y,U]=n.useState("default"),[k,de]=n.useState("preview"),[Q,X]=n.useState(!1),[O,Z]=n.useState(null),[D,me]=n.useState(F[0].key),[ee,ue]=n.useState(""),R=n.useMemo(()=>Me(),[]),te=n.useMemo(()=>{const t=[];Object.entries(R).forEach(([r,x])=>{(x||[]).forEach(m=>{const g=(m.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...m,category:r,path:g})})});const s=Object.fromEntries(t.map(r=>[r.path,r])),l=Object.fromEntries(t.map(r=>[r.token,r]));return{items:t,byPath:s,byToken:l}},[R]),_=n.useMemo(()=>{const t=(i==null?void 0:i.subject)||"",s=(i==null?void 0:i.html)||"",l=/\{\{\s*([\w.]+)\s*\}\}/g,r=new Set;let x;return[t,s].forEach(m=>{for(;x=l.exec(m);)x[1]&&r.add(x[1])}),Array.from(r)},[i==null?void 0:i.subject,i==null?void 0:i.html]),E=n.useMemo(()=>_.length?_.map(t=>{const s=te.byPath[t];if(s)return s;const l=t.split(".")[0];return{label:t,token:`{{${t}}}`,desc:"",category:l,path:t}}):[],[_,te.byPath]),xe=(t,s)=>s.split(".").reduce((l,r)=>l&&l[r]!==void 0?l[r]:"",t),he=(t,s,l)=>{const r=s.split("."),x=Array.isArray(t)?[...t]:{...t};let m=x;for(let g=0;g<r.length;g++){const f=r[g];if(g===r.length-1)m[f]=l;else{const j=m[f],h=j&&typeof j=="object"&&!Array.isArray(j);m[f]=h?{...j}:{},m=m[f]}}return x},pe=n.useMemo(()=>{const t=E.length;return k==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[k,E.length]);n.useEffect(()=>{const t=N();v(t),t.length&&y(t[0].id)},[]);const c=n.useMemo(()=>C.find(t=>t.id===p)||null,[C,p]);n.useEffect(()=>{b(c?{name:c.name||"",category:c.category||"",description:c.description||"",tags:Array.isArray(c.tags)?c.tags:[],subject:c.subject||"",html:c.html||""}:{name:"",category:"",description:"",tags:[],subject:"",html:""})},[c]);const se=n.useMemo(()=>o?Pe(o):C,[o,C]),ge=()=>{const t=$e({name:"新 HTML 郵件範本",description:""}),s=N();v(s),y(t.id)},be=t=>{const s=Be(t),l=N();v(l),s&&y(s.id)},fe=t=>{v(N())},je=()=>{var s;if(!c)return;He(c.id);const t=N();v(t),y(((s=t[0])==null?void 0:s.id)||null),S(!1)},ye=()=>{c&&(q(!0),Le(c.id,{...i}),v(N()),q(!1))},ve=[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],Ne=[{label:"welcome",value:"welcome"},{label:"member",value:"member"},{label:"order",value:"order"},{label:"logistics",value:"logistics"},{label:"promo",value:"promo"},{label:"cart",value:"cart"},{label:"remarketing",value:"remarketing"}],ae=(t,s)=>{const l=t==null?void 0:t.current;if(!l)return;const r=l.selectionStart??l.value.length,x=l.selectionEnd??l.value.length,m=l.value.slice(0,r),g=l.value.slice(x),f=`${m}${s}${g}`,j=l===L.current?"subject":"html";b(h=>({...h,[j]:f})),requestAnimationFrame(()=>{l.focus();const h=r+s.length;l.setSelectionRange(h,h)})},[V,we]=n.useState({email:""}),ke=()=>{X(!0),Z(null);const t=re({subject:i.subject,html:i.html},M);setTimeout(()=>{X(!1),Z({success:!0,message:"測試郵件已模擬送出",rendered:t})},700)},Ce=t=>{A(K(t))};return n.useEffect(()=>{H&&Ce(Y||"default")},[H]),e.jsxs("div",{className:`${a.pageContainer}`,children:[e.jsxs("div",{className:`${a.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:a.pageTitle,children:"Mail HTML"}),e.jsx("p",{className:a.pageSubtitle,children:"集中管理 Email HTML 範本（用於推銷官網）"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>c&&be(c.id),children:"複製範本"}),e.jsx("button",{className:a.primaryButton,onClick:ge,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${a.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、主旨、標籤",value:o,onChange:t=>d(t.target.value),className:`${a.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[se.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),se.map(t=>e.jsx("button",{onClick:()=>y(t.id),className:`w-full text-left p-4 transition-colors ${p===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese truncate",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.subject||"（無主旨）"}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${a.glassCard} space-y-6`,children:c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:a.input,value:i.name,onChange:t=>b(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(z,{options:ve,value:i.category,onChange:t=>b(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:a.input,value:i.description,onChange:t=>b(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(z,{options:Ne,value:i.tags,onChange:t=>b(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"主旨"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(!0),children:"插入變數"})]})]}),e.jsx("input",{ref:L,className:a.input,value:i.subject,onChange:t=>b(s=>({...s,subject:t.target.value})),placeholder:"輸入郵件主旨"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"HTML 內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:J,className:`${a.input} min-h-[260px] font-mono text-[13px]`,value:i.html,onChange:t=>b(s=>({...s,html:t.target.value})),placeholder:"輸入 Email 內嵌 HTML（建議 inline-style）"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",c.updatedAt?new Date(c.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnSecondary,onClick:()=>S(!0),children:"刪除"}),c.status!=="published"&&e.jsx("button",{className:a.btnGhost,onClick:()=>fe(c.id),children:"發佈"}),e.jsx("button",{className:a.btnGhost,onClick:()=>B(!0),children:"預覽"}),e.jsx("button",{className:`${a.btnPrimary} ${W?"opacity-70 pointer-events-none":""}`,onClick:ye,children:W?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(I,{isOpen:ce,onClose:()=>S(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",c==null?void 0:c.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>S(!1),children:"取消"}),e.jsx("button",{className:a.primaryButton,onClick:je,children:"確定刪除"})]})]})}),e.jsx(I,{isOpen:H,onClose:()=>B(!1),title:"預覽",size:pe,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(le,{mode:"controlled",activeKey:k,onTabChange:t=>de(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽與發送"},{key:"context",label:"情境與欄位"}]}),k==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-7",children:(()=>{const t=re({subject:i.subject,html:i.html},M);return e.jsx(u,{subject:t.subject,html:t.html})})()}),e.jsxs("div",{className:"col-span-5",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"發送測試"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"測試收件者（Email）"}),e.jsx("input",{className:a.input,value:(V==null?void 0:V.email)||"",onChange:t=>we(s=>({...s,email:t.target.value})),placeholder:"name@example.com"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"不會真正寄出 Email，只做本地模擬"}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:`${a.primaryButton} ${Q?"opacity-70 pointer-events-none":""}`,onClick:ke,children:Q?"傳送中…":"送出測試"})}),O&&e.jsx("div",{className:`${O.success?"text-green-700 bg-green-50":"text-red-700 bg-red-50"} p-3 rounded-lg text-sm`,children:O.message})]})]})]}),k==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(z,{options:Ae(),value:Y,onChange:t=>{U(t),A(K(t))},placeholder:"選擇情境"})]}),E.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:E.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),l=xe(M,t.path),r=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:r}),e.jsx("input",{className:a.input,value:l||"",disabled:s,onChange:x=>{const m=he(M,t.path,x.target.value);A(m)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>{U("default"),A(K("default"))},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:a.primaryButton,onClick:()=>B(!1),children:"關閉"})})]})}),e.jsx(I,{isOpen:oe,onClose:()=>T(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(le,{mode:"controlled",activeKey:D,onTabChange:t=>me(t.key),layout:"left",tabs:F.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:ee,onChange:t=>ue(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${a.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(F.find(t=>t.key===D)?R[D]:[]).filter(t=>{const s=ee.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(l=>l.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnGhost,onClick:()=>ae(L,t.token),children:"插入主旨"}),e.jsx("button",{className:a.primaryButton,onClick:()=>ae(J,t.token),children:"插入 HTML"})]})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>T(!1),children:"完成"})})]})})]})};export{ze as default};
