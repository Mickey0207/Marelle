import{r as x,j as e,A as U}from"./index-09c3368c.js";import{S}from"./SearchableSelect-bf34f521.js";import{S as E}from"./StandardTable-d1cd024c.js";import{m as M}from"./mockProductData-8411f5af.js";import{g as A,P as w,a as K}from"./categoryDataManager-0be0a985.js";import{Q as P}from"./QRCodeGenerator-edf9c63c.js";import{I as R}from"./IconActionButton-fd764fa6.js";import{B as V}from"./BuildingStorefrontIcon-94b5d89d.js";import{F as B}from"./FunnelIcon-694d59fc.js";import{Q as C}from"./QrCodeIcon-0fb2cc7f.js";import{E as I}from"./EyeIcon-bb65ea7b.js";import{E as Q}from"./ExclamationTriangleIcon-8f54841e.js";import"./chevron-down-5d12351e.js";import"./GlassModal-a6c5f610.js";import"./XMarkIcon-93d59038.js";import"./ArrowDownTrayIcon-2accbe6b.js";function $({title:i,titleId:m,...r},N){return x.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:N,"aria-labelledby":m},r),i?x.createElement("title",{id:m},i):null,x.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"}))}const F=x.forwardRef($),L=F,T=["台北一倉","新北二倉"];function O(i="*"){const m=[];for(const r of M){const N=Array.isArray(r.skuVariants)?r.skuVariants:[],n=i==="*"?T:[i];for(const h of n)for(const t of N){const f=Math.floor(Math.random()*50)-5,b=Math.floor((r.price||500)*(.5+Math.random()*.3));m.push({warehouse:h,productId:r.id,baseSKU:r.baseSKU,name:r.name,category:r.category,categoryId:r.categoryId,productImageUrl:r.image,sku:t.sku,spec:t.spec,barcode:t.barcode,currentStock:f,safeStock:10,avgCost:b,totalValue:f*b,status:f<0?"presale":f<10?"low":"normal"})}}return m}function W(i){return{warehouses:Array.from(new Set(i.map(r=>r.warehouse))).sort()}}const _=({tree:i=[],value:m=null,onChange:r,placeholder:N="選擇分類"})=>{const n=x.useCallback((d,c,g=[])=>{var u;for(const p of d){const s=[...g,p];if(p.id===c)return s;if((u=p.children)!=null&&u.length){const a=n(p.children,c,s);if(a)return a}}return null},[]),h=x.useMemo(()=>m?n(i,m):[],[i,m,n]),[t,f]=x.useState(h||[]);x.useEffect(()=>{const d=m?n(i,m):[];f(d||[])},[m,i,n]);const b=x.useMemo(()=>{const d=[];d.push(i.map(c=>({value:c.id,label:c.name,node:c})));for(let c=1;c<5;c++){const g=t[c-1],u=(g==null?void 0:g.children)||[];if(u.length)d.push(u.map(p=>({value:p.id,label:p.name,node:p})));else break}return d},[i,t]),k=(d,c)=>{var s,a;if(!c){const o=d===0?null:((s=t[d-1])==null?void 0:s.id)||null;f(l=>l.slice(0,d)),r&&r(o);return}const u=(a=(b[d]||[]).find(o=>o.value===c))==null?void 0:a.node;if(!u)return;const p=[...t.slice(0,d),u];f(p),r&&r(u.id)},v=()=>{f([]),r&&r(null)};return e.jsxs("div",{className:"flex items-center space-x-2",children:[b.map((d,c)=>{var g;return e.jsx(S,{options:[{value:"",label:c===0?"全部":"無"},...d.map(u=>({value:u.value,label:u.label}))],value:((g=t[c])==null?void 0:g.id)||"",onChange:u=>k(c,u),placeholder:c===0?N:"選擇子分類",className:"w-40"},c)}),e.jsx("button",{className:"px-2 py-1 text-xs text-gray-600 hover:bg-gray-100 rounded",onClick:v,children:"清除"})]})},oe=()=>{const[i,m]=x.useState("全部"),[r,N]=x.useState(null),[n,h]=x.useState(null),[t,f]=x.useState(null),[b,k]=x.useState(()=>O("*")),{warehouses:v}=x.useMemo(()=>W(b),[b]),d=x.useMemo(()=>{const s=b.filter(o=>{const l=i==="全部"||o.warehouse===i;let y=!0;if(r){const j=new Set([r,...A(w,r)]);y=o.categoryId?j.has(o.categoryId):!1}return l&&y}),a=new Map;for(const o of s){const l=o.productId??o.baseSKU??o.name;a.has(l)||a.set(l,{productKey:l,productId:o.productId,baseSKU:o.baseSKU,name:o.name,category:o.category,categoryId:o.categoryId,imageUrl:o.productImageUrl||o.imageUrl,totalCurrentStock:0,totalValue:0,skuCount:0,sample:o});const y=a.get(l);y.totalCurrentStock+=Number(o.currentStock||0),y.totalValue+=Number(o.totalValue||0),y.skuCount+=1}return Array.from(a.values())},[i,r,b]),c=s=>s.status==="presale"?e.jsx("span",{className:"inline-flex items-center px-2 py-1 text-xs font-bold bg-purple-100 text-purple-700 rounded font-chinese",children:"預售中"}):s.status==="low"?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 text-xs font-bold bg-red-100 text-red-700 rounded font-chinese",children:[e.jsx(Q,{className:"w-3 h-3 mr-1"}),"低庫存"]}):e.jsx("span",{className:"inline-flex items-center px-2 py-1 text-xs font-bold bg-green-100 text-green-700 rounded font-chinese",children:"正常"}),g=[{key:"imageUrl",label:"圖片",sortable:!1,render:(s,a)=>e.jsx("div",{className:"w-10 h-10 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:s?e.jsx("img",{src:s,alt:a.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-[10px] text-gray-400",children:"無圖"})})},{key:"name",label:"商品名稱",sortable:!0,render:(s,a)=>e.jsx("span",{className:"font-chinese font-medium",children:a.name})},{key:"baseSKU",label:"主 SKU",sortable:!0,render:s=>e.jsx("span",{className:"font-mono text-sm",children:s})},{key:"category",label:"分類",sortable:!0,render:s=>e.jsx("span",{className:"font-chinese",children:s})},{key:"totalCurrentStock",label:"總庫存量",sortable:!0,render:s=>e.jsx("span",{className:`font-bold ${s<0?"text-purple-600":"text-green-600"}`,children:s})},{key:"skuCount",label:"SKU 數",sortable:!0},{key:"actions",label:"操作",sortable:!1,render:(s,a)=>e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(R,{Icon:I,label:"檢視明細",variant:"gray",onClick:()=>h(a.sample)})})}],u=s=>{const a=b.filter(l=>(l.productId??l.baseSKU??l.name)===s.productKey),o=new Map;for(const l of a){const y=l.sku;o.has(y)||o.set(y,{sku:l.sku,spec:l.spec,currentStock:0,safeStock:l.safeStock,avgCost:l.avgCost,totalValue:0,barcode:l.barcode,imageUrl:l.variantImageUrl||l.productImageUrl||l.imageUrl,status:l.status,id:l.sku,name:s.name,category:s.category,warehouse:"彙總"});const j=o.get(y);j.currentStock+=Number(l.currentStock||0),j.totalValue+=Number(l.totalValue||0),typeof l.safeStock=="number"&&(typeof j.safeStock!="number"||l.safeStock<j.safeStock)&&(j.safeStock=l.safeStock),l.currentStock<0?j.status="presale":l.currentStock<l.safeStock&&j.status!=="presale"&&(j.status="low")}return Array.from(o.values())},p=[{key:"imageUrl",label:"圖片",sortable:!1,render:(s,a)=>e.jsx("div",{className:"w-10 h-10 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:s?e.jsx("img",{src:s,alt:a.sku,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-[10px] text-gray-400",children:"無圖"})})},{key:"sku",label:"SKU",sortable:!0,render:s=>e.jsx("span",{className:"font-mono text-xs text-gray-800",children:s})},{key:"spec",label:"規格",sortable:!0,render:s=>e.jsx("span",{className:"text-sm text-gray-700 font-chinese",children:s||"-"})},{key:"currentStock",label:"庫存量(總)",sortable:!0,render:(s,a)=>e.jsx("span",{className:`font-bold ${s<0?"text-purple-600":s<(a.safeStock??0)?"text-red-600":"text-green-600"}`,children:s})},{key:"safeStock",label:"安全庫存",sortable:!0},{key:"avgCost",label:"平均成本",sortable:!0},{key:"totalValue",label:"庫存價值(總)",sortable:!0},{key:"barcode",label:"條碼",sortable:!0,render:(s,a)=>e.jsxs("button",{className:"px-2 py-1 text-xs border rounded hover:bg-gray-50 flex items-center space-x-1",title:"顯示 QR",onClick:()=>f(a),children:[e.jsx(C,{className:"w-4 h-4"}),e.jsx("span",{children:s?"顯示":"產生"})]})},{key:"status",label:"狀態",sortable:!0,render:(s,a)=>c(a)}];return e.jsx("div",{className:"bg-[#fdf8f2] min-h-screen",children:e.jsxs("div",{className:U.contentContainerFluid,children:[e.jsxs("div",{className:"flex items-center mb-8",children:[e.jsx(L,{className:"w-8 h-8 text-amber-500 mr-3"}),e.jsx("h1",{className:"text-3xl font-bold text-gray-800 font-chinese",children:"庫存管理"})]}),e.jsx("div",{className:"glass rounded-2xl p-6 mb-6",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{className:"w-5 h-5 text-gray-400"}),e.jsx(S,{options:v.map(s=>({value:s,label:s==="全部"?"全部倉庫":s})),value:i,onChange:m,placeholder:"選擇倉庫",className:"w-36"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsx(_,{tree:w,value:r,onChange:N,placeholder:"選擇分類"})]}),r&&e.jsxs("div",{className:"text-xs text-gray-500 font-chinese",children:["分類路徑：",K(w,r)]}),e.jsxs("div",{className:"text-sm text-gray-500 font-chinese",children:["共",d.length," 項商品"]})]})}),e.jsx(E,{data:d,columns:g,title:"庫存清單（按商品彙總）",emptyMessage:"沒有找到符合條件的庫存資料",exportFileName:"庫存清單",enableRowExpansion:!0,getSubRows:u,subColumns:p,renderSubtableHeader:s=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[s.name," 的 SKU 彙總（跨倉庫）"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["共 ",u(s).length," 項 SKU"]})]}),subtableClassName:"rounded-lg"}),n&&e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:()=>h(null)}),e.jsxs("div",{className:"absolute right-0 top-0 h-full w-[460px] bg-white shadow-2xl p-6 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold font-chinese",children:"庫存詳情"}),e.jsx("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>h(null),children:"✕"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2 font-chinese",children:"基本資訊"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 font-chinese",children:"SKU"}),e.jsx("span",{className:"font-mono text-gray-900",children:n.sku})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 font-chinese",children:"商品名稱"}),e.jsx("span",{className:"font-chinese text-gray-900 max-w-[60%] truncate text-right",children:n.name})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 font-chinese",children:"規格"}),e.jsx("span",{className:"font-chinese text-gray-900 max-w-[60%] truncate text-right",children:n.spec||"-"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 font-chinese",children:"分類"}),e.jsx("span",{className:"font-chinese text-gray-900",children:e.jsx("span",{className:"px-2 py-0.5 rounded bg-gray-100",children:n.category})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"倉庫"}),e.jsx("div",{className:"w-full",children:e.jsx(S,{options:v.filter(s=>s!=="全部").map(s=>({value:s,label:s})),value:n.warehouse,onChange:s=>h(a=>({...a,warehouse:s})),placeholder:"選擇倉庫",className:"w-full"})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-500 font-chinese",children:"更新日期"}),e.jsx("span",{className:"text-gray-600",children:n.lastUpdated})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2 font-chinese",children:"數量設定"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"庫存量"}),e.jsx("input",{type:"number",className:"w-full border rounded px-3 py-2",value:n.currentStock,onChange:s=>h(a=>({...a,currentStock:Number(s.target.value)}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"安全庫存"}),e.jsx("input",{type:"number",className:"w-full border rounded px-3 py-2",value:n.safeStock,onChange:s=>h(a=>({...a,safeStock:Number(s.target.value)}))})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2 font-chinese",children:"成本與價值"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"平均成本"}),e.jsx("input",{type:"number",className:"w-full border rounded px-3 py-2",value:n.avgCost,onChange:s=>h(a=>({...a,avgCost:Number(s.target.value)}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"庫存價值"}),e.jsx("input",{type:"number",className:"w-full border rounded px-3 py-2",value:n.totalValue,onChange:s=>h(a=>({...a,totalValue:Number(s.target.value)}))})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2 font-chinese",children:"其他"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600 font-chinese",children:"允許預購"}),e.jsx("button",{className:`px-3 py-1 rounded text-xs font-chinese ${n.allowNegative?"bg-purple-100 text-purple-700":"bg-gray-100 text-gray-600"}`,onClick:()=>h(s=>({...s,allowNegative:!s.allowNegative})),children:n.allowNegative?"允許":"禁止"})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1 font-chinese",children:"條碼"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-mono text-xs",children:n.barcode}),e.jsxs("button",{className:"px-2 py-1 text-xs border rounded hover:bg-gray-50 flex items-center space-x-1",onClick:()=>f(n),children:[e.jsx(C,{className:"w-4 h-4"})," ",e.jsx("span",{children:"顯示 QR"})]})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:"px-4 py-2 bg-[#cc824d] text-white rounded hover:bg-[#b3723f] font-chinese",onClick:()=>{k(s=>s.map(a=>a.id===n.id?{...a,...n,totalValue:Math.round(Number(n.currentStock)*Number(n.avgCost||0))}:a)),h(null)},children:"完成"})})]})]})]}),e.jsx(P,{isOpen:!!t,onClose:()=>f(null),title:t?`QR 預覽 - ${t.sku}`:"QR 預覽",product:{id:t==null?void 0:t.sku,name:t==null?void 0:t.name,slug:t==null?void 0:t.sku,price:t==null?void 0:t.totalValue,comparePrice:null,costPrice:t==null?void 0:t.avgCost,categories:[t==null?void 0:t.category].filter(Boolean)},sku:{id:t==null?void 0:t.id,sku:t==null?void 0:t.sku,price:null,comparePrice:null,costPrice:t==null?void 0:t.avgCost,variantPath:t!=null&&t.spec&&(t==null?void 0:t.spec)!=="-"?t.spec.split(" / ").map(s=>({level:"規格",option:s})):[]},details:t?[{label:"商品名稱",value:t.name},{label:"SKU",value:t.sku,mono:!0},{label:"規格",value:t.spec||"-"},{label:"分類",value:t.category},{label:"倉庫",value:t.warehouse},{label:"庫存量",value:t.currentStock},{label:"安全庫存",value:t.safeStock},{label:"平均成本",value:`NT$ ${Number(t.avgCost).toLocaleString()}`},{label:"庫存價值",value:`NT$ ${Number(t.totalValue).toLocaleString()}`},{label:"條碼",value:t.barcode,mono:!0},{label:"允許預購",value:t.allowNegative?"允許":"禁止"},{label:"更新日期",value:t.lastUpdated}]:void 0})]})})};export{oe as default};
