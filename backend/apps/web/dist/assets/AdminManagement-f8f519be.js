import{r as n,R as X,j as s,A as o}from"./index-5be64975.js";import{S as ee}from"./StandardTable-046e436b.js";import{G as w}from"./GlassModal-8d9cbd14.js";import{S as p}from"./SearchableSelect-06cd3eb3.js";import{I}from"./IconActionButton-2bcd0b2a.js";import{a as se,b as te,l as ae,g as le,s as ne,c as re,u as ie}from"./index-3a4190b3.js";import{U as oe}from"./UsersIcon-99672bc6.js";import{P as ce}from"./PlusIcon-86b6a2f5.js";import{P as de}from"./PencilIcon-0921d86f.js";import"./chevron-down-e41c1b61.js";import"./XMarkIcon-404a829f.js";function me({title:d,titleId:c,...b},N){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:N,"aria-labelledby":c},b),d?n.createElement("title",{id:c},d):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"}))}const ue=n.forwardRef(me),xe=ue,m=(d,c)=>s.jsx("span",{className:`inline-flex items-center px-2 py-1 text-xs font-bold rounded font-chinese ${c}`,children:d}),_e=()=>{const[d,c]=n.useState([]),[b,N]=n.useState([]),[pe,_]=n.useState(!1),[be,M]=n.useState(null),[R,L]=n.useState([]),[A,F]=n.useState({});X.useEffect(()=>{let e=!0;return(async()=>{_(!0);try{const[t,a,C]=await Promise.all([se(),te(),ae()]);if(e&&L((t||[]).map(l=>({key:l.key||l.name,label:l.label||l.key||l.name}))),e&&N(a||[]),!e)return;const v=C.map(l=>({id:l.id,department:l.department||"",name:l.display_name||l.email,email:l.email,role:l.role||"Staff",status:l.is_active?"active":"inactive",lastLogin:"-",line_display_name:l.line_display_name||null,line_user_id:l.line_user_id||null,line_picture_url:l.line_picture_url||null}));c(v);const Q=Array.from(new Set([...(a||[]).map(l=>l.name),...v.map(l=>l.role)].filter(Boolean))),V=await Promise.all(Q.map(async l=>[l,await le(l)]));e&&F(Object.fromEntries(V))}catch(t){M((t==null?void 0:t.message)||"載入管理員失敗")}finally{_(!1)}})(),()=>{e=!1}},[]);const k=n.useMemo(()=>{const e=new Set(["全部"]);return b.forEach(t=>e.add(t.name)),d.forEach(t=>{t.role&&e.add(t.role)}),Array.from(e)},[d,b]),[P,O]=n.useState([]),[S,$]=n.useState(""),[h,B]=n.useState("全部"),[f,z]=n.useState("全部"),[H,g]=n.useState(!1),[K,j]=n.useState(!1);n.useState(null);const[E,y]=n.useState({open:!1,message:""}),T=n.useMemo(()=>d.filter(e=>{const a=`${e.department||""} ${e.name} ${e.email}`.toLowerCase().includes(S.trim().toLowerCase()),C=h==="全部"||e.role===h,v=f==="全部"||e.status===f;return a&&C&&v}),[d,S,h,f]),G=e=>e.id,U=[{key:"department",label:"部門",sortable:!0,render:e=>s.jsx("span",{className:"font-chinese font-medium",children:e||"-"})},{key:"name",label:"暱稱",sortable:!0,render:e=>s.jsx("span",{className:"font-chinese font-medium",children:e})},{key:"email",label:"Email",sortable:!0},{key:"role",label:"角色",sortable:!0,render:e=>m(e,{"Super Admin":"bg-purple-100 text-purple-700",Manager:"bg-blue-100 text-blue-700",Staff:"bg-gray-100 text-gray-700"}[e]||"bg-gray-100 text-gray-700")},{key:"line_display_name",label:"LINE 暱稱",sortable:!0,render:e=>e?s.jsx("span",{className:"font-chinese",children:e}):s.jsx("span",{className:"text-gray-400",children:"-"})},{key:"line_user_id",label:"LINE 綁定",sortable:!0,render:e=>e?m("已綁定","bg-green-100 text-green-700"):m("未綁定","bg-gray-100 text-gray-700")},{key:"line_picture_url",label:"LINE 頭像",sortable:!1,render:e=>e?s.jsx("img",{src:e,alt:"avatar",className:"w-8 h-8 rounded-full object-cover border"}):s.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-100 border"})},{key:"status",label:"狀態",sortable:!0,render:e=>e==="active"?m("啟用中","bg-green-100 text-green-700"):m("停用","bg-red-100 text-red-700")},{key:"lastLogin",label:"最後登入",sortable:!0},{key:"actions",label:"操作",sortable:!1,render:(e,t)=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(I,{Icon:de,label:"編輯",variant:"amber",onClick:()=>q(t)}),s.jsx(I,{Icon:xe,label:"寄送重設密碼信",variant:"gray",onClick:async()=>{try{await ne(t.id),y({open:!0,message:"已寄出重設密碼信，請提醒對方至信箱收信。"})}catch(a){y({open:!0,message:(a==null?void 0:a.message)||"寄送失敗"})}}})]})}],D=e=>{const t=A[e.role]||[];return R.map(a=>({id:`${e.id}-${a.key}`,moduleKey:a.key,moduleLabel:a.label,granted:t.includes(a.key)}))},W=[{key:"moduleLabel",label:"模組",sortable:!0},{key:"granted",label:"可用",sortable:!0,render:e=>s.jsx("div",{className:"flex items-center gap-2",children:e?m("啟用","bg-green-100 text-green-700"):m("停用","bg-gray-100 text-gray-700")})}],Y=[{label:"批次啟用",onClick:e=>c(t=>t.map(a=>e.includes(a.id)?{...a,status:"active"}:a))},{label:"批次停用",onClick:e=>c(t=>t.map(a=>e.includes(a.id)?{...a,status:"inactive"}:a))},{label:"批次刪除",variant:"danger",onClick:e=>c(t=>t.filter(a=>!e.includes(a.id)))}],[r,u]=n.useState({department:"",name:"",email:"",password:"",role:"Staff"}),Z=async()=>{if(!(!r.email||!r.password))try{const e=await re({email:r.email,password:r.password,display_name:r.name,role:r.role,department:r.department}),t=e==null?void 0:e.id;c(a=>[{id:t,department:r.department,name:r.name,email:r.email,role:r.role,status:"active",lastLogin:"-",line_display_name:null,line_user_id:null,line_picture_url:null},...a]),g(!1),u({department:"",name:"",email:"",password:"",role:"Staff"})}catch(e){alert((e==null?void 0:e.message)||"建立管理員失敗")}},[i,x]=n.useState({id:"",department:"",name:"",email:"",role:"Staff",status:"active"}),q=e=>{x({id:e.id,department:e.department||"",name:e.name,email:e.email,role:e.role,status:e.status}),j(!0)},J=async()=>{try{await ie(i.id,{display_name:i.name,department:i.department,role:i.role,is_active:i.status==="active"})}catch(e){alert((e==null?void 0:e.message)||"更新管理員失敗");return}c(e=>e.map(t=>t.id===i.id?{...t,department:i.department,name:i.name,email:i.email,role:i.role,status:i.status}:t)),j(!1)};return s.jsx("div",{className:"bg-[#fdf8f2] min-h-screen",children:s.jsxs("div",{className:o.contentContainerFluid,children:[s.jsxs("div",{className:"flex items-center justify-between mb-8",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(oe,{className:"w-8 h-8 text-amber-500 mr-3"}),s.jsx("h1",{className:"text-3xl font-bold text-gray-800 font-chinese",children:"管理員管理"})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("button",{className:o.btnPrimary,onClick:()=>g(!0),children:s.jsxs("span",{className:"inline-flex items-center",children:[s.jsx(ce,{className:"w-5 h-5 mr-2"}),"新增管理員"]})})})]}),s.jsx("div",{className:`${o.glassCard} mb-6`,children:s.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"搜尋"}),s.jsx("input",{className:o.input,placeholder:"部門/暱稱/Email",value:S,onChange:e=>$(e.target.value)})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(p,{options:k,value:h,onChange:e=>B(e),placeholder:"選擇角色"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"狀態"}),s.jsx(p,{options:["全部","active","inactive"],value:f,onChange:e=>z(e),placeholder:"選擇狀態"})]})]})}),s.jsx(ee,{data:T,columns:U,title:"管理員清單",exportFileName:"管理員清單",enableBatchSelection:!0,selectedItems:P,onSelectedItemsChange:O,batchActions:Y,getRowId:G,enableRowExpansion:!0,getSubRows:e=>D(e),subColumns:W,subtableClassName:"rounded-lg"}),s.jsx(w,{isOpen:H,onClose:()=>g(!1),title:"新增管理員",size:"max-w-3xl",children:s.jsxs("div",{className:"pt-0 px-6 pb-6 space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"暱稱"}),s.jsx("input",{className:o.input,value:r.name,onChange:e=>u(t=>({...t,name:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"Email"}),s.jsx("input",{className:o.input,type:"email",value:r.email,onChange:e=>u(t=>({...t,email:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"密碼"}),s.jsx("input",{className:o.input,type:"password",value:r.password,onChange:e=>u(t=>({...t,password:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"部門"}),s.jsx("input",{className:o.input,value:r.department,onChange:e=>u(t=>({...t,department:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(p,{options:k.filter(e=>e!=="全部"),value:r.role,onChange:e=>u(t=>({...t,role:e})),placeholder:"選擇角色"})]})]}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:o.btnSecondary,onClick:()=>g(!1),children:"取消"}),s.jsx("button",{className:o.btnPrimary,onClick:Z,children:"建立"})]})]})}),s.jsx(w,{isOpen:K,onClose:()=>j(!1),title:"編輯管理員",size:"max-w-2xl",children:s.jsxs("div",{className:"pt-0 px-6 pb-6 space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"部門"}),s.jsx("input",{className:o.input,value:i.department,onChange:e=>x(t=>({...t,department:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"暱稱"}),s.jsx("input",{className:o.input,value:i.name,onChange:e=>x(t=>({...t,name:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"Email"}),s.jsx("input",{className:o.input,type:"email",value:i.email,onChange:e=>x(t=>({...t,email:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(p,{options:k.filter(e=>e!=="全部"),value:i.role,onChange:e=>x(t=>({...t,role:e})),placeholder:"選擇角色"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"狀態"}),s.jsx(p,{options:["active","inactive"],value:i.status,onChange:e=>x(t=>({...t,status:e})),placeholder:"選擇狀態"})]})]}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:o.btnSecondary,onClick:()=>j(!1),children:"取消"}),s.jsx("button",{className:o.btnPrimary,onClick:J,children:"儲存"})]})]})}),s.jsx(w,{isOpen:E.open,onClose:()=>y({open:!1,message:""}),title:"通知",size:"max-w-md",children:s.jsxs("div",{className:"pt-0 px-6 pb-6 space-y-4",children:[s.jsx("p",{className:"text-gray-700 font-chinese",children:E.message}),s.jsx("div",{className:"flex justify-end",children:s.jsx("button",{className:o.btnPrimary,onClick:()=>y({open:!1,message:""}),children:"關閉"})})]})})]})})};export{_e as default};
