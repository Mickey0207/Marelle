import{r as a,j as e,A as V}from"./index-5be64975.js";import{S}from"./StandardTable-046e436b.js";import{G as E}from"./GlassModal-8d9cbd14.js";import{I as v}from"./IconActionButton-2bcd0b2a.js";import{c}from"./chartOfAccountsManager-49e72544.js";import{S as b}from"./SearchableSelect-06cd3eb3.js";import{P as I}from"./PencilIcon-0921d86f.js";import{T as O}from"./TrashIcon-c73d815d.js";import{P as T}from"./PlusIcon-86b6a2f5.js";import"./chevron-down-e41c1b61.js";import"./XMarkIcon-404a829f.js";function ne(){const[u,_]=a.useState([]),[F,K]=a.useState([]),[N,h]=a.useState(!1),[A,f]=a.useState(null),[i,r]=a.useState({id:"",name:"",eventKey:"",active:!0,lines:[]}),[y,k]=a.useState(!1),[P,p]=a.useState(!1),[m,d]=a.useState({code:"",name:"",type:"資產",normal:"借",active:!0}),[j,C]=a.useState(null),g=()=>{_(c.listAccounts()),K(c.listAutomations())};a.useEffect(()=>{g()},[]),a.useEffect(()=>{if(N){const s=setTimeout(()=>k(!0),250);return()=>{clearTimeout(s),k(!1)}}k(!1)},[N]);const R=a.useMemo(()=>u.filter(s=>s.normal==="借"),[u]),D=a.useMemo(()=>u.filter(s=>s.normal==="貸"),[u]),H=a.useMemo(()=>["訂單建立","訂單收款","訂單退款"],[]),$=a.useMemo(()=>({訂單建立:["訂單含稅總額","銷貨收入（未稅-折扣）","銷貨成本"],訂單收款:["收款金額"],訂單退款:["退款總額"]}),[]),z=a.useMemo(()=>["借","貸"],[]),B=a.useMemo(()=>u.map(s=>({value:s.code,label:`${s.code} - ${s.name}`})),[u]),M=a.useMemo(()=>[{key:"code",label:"代碼",sortable:!0,render:s=>e.jsx("span",{className:"font-mono text-sm",children:s})},{key:"name",label:"名稱",sortable:!0},{key:"type",label:"類別",sortable:!0},{key:"normal",label:"正常餘額",sortable:!0},{key:"active",label:"狀態",sortable:!0,render:s=>e.jsx("span",{className:`inline-flex px-2 py-1 text-xs rounded-full ${s?"bg-green-100 text-green-800":"bg-gray-100 text-gray-700"}`,children:s?"啟用":"停用"})},{key:"actions",label:"操作",sortable:!1,render:(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{Icon:I,label:"編輯",variant:"amber",onClick:()=>{C(t),d(t),p(!0)}}),e.jsx(v,{Icon:O,label:"刪除",variant:"red",onClick:()=>{c.deleteAccount(t.code),g()}})]})}],[]),G=a.useMemo(()=>[{key:"id",label:"ID",sortable:!0},{key:"name",label:"名稱",sortable:!0},{key:"eventKey",label:"事件鍵",sortable:!0},{key:"active",label:"啟用",sortable:!0,render:s=>e.jsx("span",{className:`inline-flex px-2 py-1 text-xs rounded-full ${s?"bg-green-100 text-green-800":"bg-gray-100 text-gray-700"}`,children:s?"啟用":"停用"})},{key:"actions",label:"操作",sortable:!1,render:(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{Icon:I,label:"編輯",variant:"amber",onClick:()=>{f(t),r(t),h(!0)}}),e.jsx(v,{Icon:O,label:"刪除",variant:"red",onClick:()=>{c.deleteAutomation(t.id),g()}})]})}],[]),L=a.useMemo(()=>[{key:"accountCode",label:"科目代碼",sortable:!0},{key:"accountName",label:"科目名稱",sortable:!0,render:(s,t)=>{var l;return((l=c.getAccountByCode(t.accountCode))==null?void 0:l.name)||""}},{key:"side",label:"借/貸",sortable:!0},{key:"amountSource",label:"金額來源",sortable:!0},{key:"note",label:"說明",sortable:!1}],[]),U=()=>{if(j)c.updateAccount(j.code,m);else{const s=c.createAccount(m);s.success||alert(s.message||"新增失敗")}p(!1),C(null),d({code:"",name:"",type:"資產",normal:"借",active:!0}),g()},Y=()=>{if(!i.id){alert("請輸入規則 ID");return}c.upsertAutomation(i),h(!1),f(null),r({id:"",name:"",eventKey:"",active:!0,lines:[]}),g()};return e.jsxs("div",{className:"min-h-screen bg-[#fdf8f2]",children:[e.jsxs("div",{className:V.contentContainerFluid,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800 font-chinese",children:"會計科目"}),e.jsxs("button",{className:"inline-flex items-center px-6 py-3 bg-[#cc824d] text-white font-medium rounded-lg hover:bg-[#b86c37] transition-all duration-200 shadow-md hover:shadow-lg font-chinese",onClick:()=>{C(null),d({code:"",name:"",type:"資產",normal:"借",active:!0}),p(!0)},children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"新增科目"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-8",children:[e.jsx("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-200/50 shadow-sm",children:e.jsx(S,{title:"借記表格",data:R,columns:M,exportFileName:"借記科目"})}),e.jsx("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-200/50 shadow-sm",children:e.jsx(S,{title:"貸記表格",data:D,columns:M,exportFileName:"貸記科目"})})]}),e.jsxs("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-200/50 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 pt-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 font-chinese",children:"日記帳自動化規則"}),e.jsxs("button",{className:"inline-flex items-center px-4 py-2 bg-[#cc824d] text-white text-sm rounded-lg hover:bg-[#b86c37] transition-all duration-200 shadow-sm font-chinese",onClick:()=>{f(null),r({id:"",name:"",eventKey:"",active:!0,lines:[]}),h(!0)},children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),"新增規則"]})]}),e.jsx(S,{title:"",data:F,columns:G,exportFileName:"自動化規則",enableRowExpansion:!0,getSubRows:s=>s.lines||[],subColumns:L,renderSubtableHeader:s=>e.jsxs("div",{className:"text-sm text-gray-600",children:[s.name,"（",s.eventKey,"）的分錄設定"]})})]})]}),e.jsx(E,{isOpen:P,onClose:()=>p(!1),title:j?"編輯科目":"新增科目",size:"max-w-xl",maxHeight:"max-h-[80vh]",contentMaxHeight:"max-h-[calc(80vh-80px)]",children:e.jsxs("div",{className:"p-6 pt-0 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"代碼"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:m.code,onChange:s=>d(t=>({...t,code:s.target.value})),disabled:!!j})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"名稱"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:m.name,onChange:s=>d(t=>({...t,name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"類別"}),e.jsx(b,{options:c.TYPES,value:m.type,onChange:s=>d(t=>({...t,type:s})),placeholder:"選擇類別"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"正常餘額"}),e.jsx(b,{options:c.NORMAL,value:m.normal,onChange:s=>d(t=>({...t,normal:s})),placeholder:"選擇正常餘額"})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("label",{className:"inline-flex items-center text-sm text-gray-700",children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:!!m.active,onChange:s=>d(t=>({...t,active:s.target.checked}))}),"啟用"]})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200",onClick:()=>p(!1),children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-[#cc824d] text-white hover:bg-[#b86c37]",onClick:U,children:"儲存"})]})]})}),e.jsx(E,{isOpen:N,onClose:()=>h(!1),title:A?"編輯自動化規則":"新增自動化規則",size:"max-w-3xl",maxHeight:"max-h-[80vh]",contentMaxHeight:"max-h-[calc(80vh-80px)]",children:e.jsxs("div",{className:"p-6 pt-0 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"規則 ID"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.id,onChange:s=>r(t=>({...t,id:s.target.value})),disabled:!!A})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"名稱"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.name,onChange:s=>r(t=>({...t,name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 mb-1",children:"事件鍵（選取）"}),y?e.jsx(b,{options:H,value:i.eventKey,onChange:s=>r(t=>({...t,eventKey:s,lines:(t.lines||[]).map(l=>({...l,amountSource:""}))})),placeholder:"請選擇事件",allowClear:!0}):e.jsx("div",{className:"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-400 select-none",children:"請選擇事件"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("label",{className:"inline-flex items-center text-sm text-gray-700",children:[e.jsx("input",{type:"checkbox",className:"mr-2",checked:!!i.active,onChange:s=>r(t=>({...t,active:s.target.checked}))}),"啟用"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium",children:"分錄明細"}),e.jsx("button",{className:"px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200",onClick:()=>r(s=>({...s,lines:[...s.lines||[],{accountCode:"",side:"借",amountSource:"",note:""}]})),children:"新增一列"})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"科目代碼"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"借/貸"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"金額來源（選取）"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"說明"}),e.jsx("th",{className:"px-3 py-2"})]})}),e.jsx("tbody",{children:(i.lines||[]).map((s,t)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-3 py-1.5",children:y?e.jsx(b,{options:B,value:s.accountCode||"",onChange:l=>{r(o=>{const n=[...o.lines];return n[t]={...n[t],accountCode:l},{...o,lines:n}})},placeholder:"選擇科目",allowClear:!0}):e.jsx("div",{className:"w-full px-2 py-1 border border-gray-200 rounded bg-gray-50 text-gray-400 select-none",children:"選擇科目"})}),e.jsx("td",{className:"px-3 py-1.5",children:y?e.jsx(b,{options:z,value:s.side||"",onChange:l=>{r(o=>{const n=[...o.lines];return n[t]={...n[t],side:l},{...o,lines:n}})},placeholder:"選擇借/貸"}):e.jsx("div",{className:"w-full px-2 py-1 border border-gray-200 rounded bg-gray-50 text-gray-400 select-none",children:"選擇借/貸"})}),e.jsx("td",{className:"px-3 py-1.5",children:y?(()=>{const l=$[i.eventKey]||[],o=s.amountSource&&!l.includes(s.amountSource)?[...l,s.amountSource]:l;return e.jsx(b,{options:o,value:s.amountSource||"",onChange:n=>{r(x=>{const w=[...x.lines];return w[t]={...w[t],amountSource:n},{...x,lines:w}})},placeholder:"選擇金額來源",allowClear:!0})})():e.jsx("div",{className:"w-full px-2 py-1 border border-gray-200 rounded bg-gray-50 text-gray-400 select-none",children:"選擇金額來源"})}),e.jsx("td",{className:"px-3 py-1.5",children:e.jsx("input",{className:"w-full px-2 py-1 border border-gray-300 rounded",value:s.note||"",onChange:l=>{const o=l.target.value;r(n=>{const x=[...n.lines];return x[t]={...x[t],note:o},{...n,lines:x}})}})}),e.jsx("td",{className:"px-3 py-1.5 text-right",children:e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>r(l=>({...l,lines:(l.lines||[]).filter((o,n)=>n!==t)})),children:"刪除"})})]},t))})]})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200",onClick:()=>h(!1),children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-[#cc824d] text-white hover:bg-[#b86c37]",onClick:Y,children:"儲存"})]})]})})]})}export{ne as default};
