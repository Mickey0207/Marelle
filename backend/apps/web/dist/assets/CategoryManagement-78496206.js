import{j as e,r,A as O}from"./index-5be64975.js";import{S as Y}from"./StandardTable-046e436b.js";import{C as R}from"./CategoryCascader-5a3024a1.js";import{G as P}from"./GlassModal-8d9cbd14.js";import{I as H}from"./ImageUpload-68adf005.js";import{I as D}from"./IconActionButton-2bcd0b2a.js";import{P as q}from"./PlusIcon-86b6a2f5.js";import{P as K}from"./PencilIcon-0921d86f.js";import{T as Q}from"./TrashIcon-c73d815d.js";import"./chevron-down-e41c1b61.js";import"./SearchableSelect-06cd3eb3.js";import"./XMarkIcon-404a829f.js";const W=({isOpen:o,onClose:c,onConfirm:m,title:d="確認操作",message:y="確定要執行此操作嗎？",confirmVariant:j="danger",cancelText:u="取消",confirmText:k="確認",isLoading:t=!1})=>e.jsx(P,{isOpen:o,onClose:c,title:d,size:"max-w-md",children:e.jsxs("div",{className:"p-6 pt-0",children:[e.jsx("p",{className:"text-gray-700 mb-6",children:y}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:c,disabled:t,className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 disabled:opacity-50 transition",children:u}),e.jsx("button",{onClick:m,disabled:t,className:`px-4 py-2 rounded-lg text-white transition disabled:opacity-50 ${j==="danger"?"bg-red-600 hover:bg-red-700":"bg-[#cc824d] hover:bg-[#b8734a]"}`,children:t?"處理中...":k})]})]})}),L=({data:o=[],depth:c=1,onEdit:m,onDelete:d})=>{const y=(t,s)=>{function I(T,v){for(const g of v){if(g.id===T)return[g.name];if(g.children&&g.children.length>0){const N=I(T,g.children);if(N)return[g.name,...N]}}return null}const p=I(t.id,s);return p?p.join(" / "):t.name},j=[{key:"image",label:"圖片",sortable:!1,render:(t,s)=>e.jsx("div",{className:"w-10 h-10 rounded-md overflow-hidden bg-gray-100 flex items-center justify-center",children:s.image?e.jsx("img",{src:s.image,alt:`${s.name} 圖片`,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-[10px] text-gray-400",children:"無圖"})})},{key:"name",label:"分類名稱",sortable:!0,render:(t,s)=>e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"text-gray-900",children:s.name})})},{key:"breadcrumb",label:"階層",sortable:!1,render:(t,s)=>e.jsx("span",{className:"text-sm text-gray-600",children:y(s,o)})},{key:"slug",label:"Slug",sortable:!0,render:t=>e.jsx("span",{className:"font-mono text-xs text-gray-700",children:t})},{key:"actions",label:"操作",sortable:!1,render:(t,s)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(D,{Icon:K,label:"編輯",variant:"amber",onClick:()=>m==null?void 0:m(s)}),e.jsx(D,{Icon:Q,label:"刪除",variant:"red",onClick:()=>d==null?void 0:d(s)})]})}],u=t=>{const s=t.children||[];return s.length?[{__container__:!0,children:s}]:[]},k=[{key:"__container__",label:"子分類",sortable:!1,render:(t,s)=>e.jsx("div",{className:"py-2",children:e.jsx(L,{data:s.children,depth:c+1,onEdit:m,onDelete:d})})}];return e.jsx(Y,{title:c===1?"分類清單":`第 ${c} 層`,columns:j,data:o,exportFileName:c===1?"product-categories":`product-categories-level-${c}`,emptyMessage:"沒有找到符合條件的分類",enableRowExpansion:!0,getSubRows:u,subColumns:k,subtableClassName:"bg-white/70 rounded-xl",getRowId:(t,s)=>t.id||t.slug||s})},de=()=>{const[o,c]=r.useState([]),[m,d]=r.useState(!1),[y,j]=r.useState(null),[u,k]=r.useState(""),[t,s]=r.useState(null),[I,p]=r.useState(!1),[T,v]=r.useState(!1),[g,N]=r.useState(!1),[x,_]=r.useState(null),[F,M]=r.useState(null),[i,h]=r.useState({name:"",slug:""}),[b,w]=r.useState([]),[n,C]=r.useState(!1);r.useEffect(()=>{E()},[]);const E=async()=>{try{d(!0),j(null);const a=await fetch("/backend/categories",{method:"GET",credentials:"include"});if(!a.ok)throw new Error("Failed to fetch categories");const l=await a.json();c(l||[])}catch(a){j(a.message||"Error loading categories"),console.error(a)}finally{d(!1)}},A=r.useMemo(()=>{if(!u)return o;const a=u.toLowerCase();function l(f){const S=(f.name||"").toLowerCase().includes(a),$=(f.children||[]).map(l).filter(Boolean);return S||$.length?{...f,children:$}:null}return o.map(l).filter(Boolean)},[o,u]),B=(a=null)=>{M((a==null?void 0:a.id)||null),h({name:"",slug:""}),w([]),p(!0)},z=a=>{_(a),h({name:a.name||"",slug:a.slug||""}),w(a.image?[{id:`${a.slug}-img`,url:a.image,name:a.name||"image"}]:[]),v(!0)},G=a=>{_(a),N(!0)},J=async()=>{if(!i.name||!i.slug){alert("請填寫名稱和Slug");return}try{C(!0);const a={name:i.name,slug:i.slug,parent_id:F,image_url:""},l=await fetch("/backend/categories",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!l.ok)throw new Error("Failed to create category");const f=await l.json();if(b.length>0&&b[0].file){const S=new FormData;S.append("file",b[0].file),(await fetch(`/backend/categories/${f.id}/upload-image`,{method:"POST",credentials:"include",body:S})).ok||console.warn("Image upload failed, but category created")}await E(),p(!1),h({name:"",slug:""}),w([])}catch(a){alert(`建立失敗: ${a.message}`),console.error(a)}finally{C(!1)}},U=async()=>{if(!x||!i.name||!i.slug){alert("請填寫名稱和Slug");return}try{C(!0);const a={name:i.name,slug:i.slug};if(!(await fetch(`/backend/categories/${x.id}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok)throw new Error("Failed to update category");if(b.length>0&&b[0].file){const f=new FormData;f.append("file",b[0].file),(await fetch(`/backend/categories/${x.id}/upload-image`,{method:"POST",credentials:"include",body:f})).ok||console.warn("Image upload failed, but category updated")}await E(),v(!1),_(null),h({name:"",slug:""}),w([])}catch(a){alert(`編輯失敗: ${a.message}`),console.error(a)}finally{C(!1)}},V=async()=>{if(x)try{if(C(!0),!(await fetch(`/backend/categories/${x.id}`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Failed to delete category");await E(),N(!1),_(null)}catch(a){alert(`刪除失敗: ${a.message}`),console.error(a)}finally{C(!1)}};return e.jsxs("div",{className:O.pageContainer,children:[e.jsxs("div",{className:O.contentContainerFluid,children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:O.pageTitle,children:"分類管理"}),e.jsx("p",{className:O.pageSubtitle,children:"建立與管理產品分類階層（支援最多五層）"})]}),e.jsxs("button",{onClick:()=>B(null),className:"inline-flex items-center px-6 py-3 bg-[#cc824d] text-white font-medium rounded-lg hover:bg-[#b86c37] transition-all duration-200 shadow-md hover:shadow-lg font-chinese",children:[e.jsx(q,{className:"w-5 h-5 mr-2"}),"新增分類"]})]}),y&&e.jsx("div",{className:"mb-4 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700",children:y}),e.jsx("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-200/50 shadow-sm p-6 mb-6",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{className:"px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#cc824d]",placeholder:"搜尋分類名稱",value:u,onChange:a=>k(a.target.value)}),e.jsx(R,{tree:o,value:t,onChange:s})]})}),e.jsx("div",{className:"bg-white/80 backdrop-blur-sm rounded-2xl border border-gray-200/50 shadow-sm",children:m?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"載入中..."}):e.jsx(L,{data:A,onEdit:z,onDelete:G})})]}),e.jsx(P,{isOpen:I,onClose:()=>p(!1),title:"新增分類",size:"max-w-lg",maxHeight:"max-h-[80vh]",contentMaxHeight:"max-h-[calc(80vh-80px)]",children:e.jsxs("div",{className:"p-6 pt-0 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"上層分類（可留空）"}),e.jsx(R,{tree:o,value:F,onChange:M})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"名稱*"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.name,onChange:a=>h(l=>({...l,name:a.target.value})),disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Slug*"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.slug,onChange:a=>h(l=>({...l,slug:a.target.value})),disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"分類圖片"}),e.jsx(H,{images:b,onChange:a=>w(a),maxImages:1,disabled:n})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>p(!1),disabled:n,children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-[#cc824d] text-white hover:bg-[#b86c37] disabled:opacity-50",onClick:J,disabled:n,children:n?"建立中...":"新增"})]})]})}),e.jsx(P,{isOpen:T,onClose:()=>v(!1),title:"編輯分類",size:"max-w-lg",maxHeight:"max-h-[80vh]",contentMaxHeight:"max-h-[calc(80vh-80px)]",children:e.jsxs("div",{className:"p-6 pt-0 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"名稱*"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.name,onChange:a=>h(l=>({...l,name:a.target.value})),disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Slug*"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg",value:i.slug,onChange:a=>h(l=>({...l,slug:a.target.value})),disabled:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"分類圖片"}),e.jsx(H,{images:b,onChange:a=>w(a),maxImages:1,disabled:n})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>v(!1),disabled:n,children:"取消"}),e.jsx("button",{className:"px-4 py-2 rounded-lg bg-[#cc824d] text-white hover:bg-[#b86c37] disabled:opacity-50",onClick:U,disabled:n,children:n?"儲存中...":"儲存"})]})]})}),e.jsx(W,{isOpen:g,onClose:()=>N(!1),onConfirm:V,title:"確認刪除",message:`確定要刪除分類「${x==null?void 0:x.name}」及其所有子分類嗎？此操作無法復原。`,confirmVariant:"danger",isLoading:n})]})};export{de as default};
