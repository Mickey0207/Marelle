import{r as a,j as e,A as n}from"./index-5be64975.js";import{G as D}from"./GlassModal-8d9cbd14.js";import{T as Q}from"./TabNavigation-b0ee78ba.js";import{S as I}from"./SearchableSelect-06cd3eb3.js";import{b as X,V as Z,g as we,r as ee,a as Ce,c as ke}from"./presets-f50821a2.js";import"./XMarkIcon-404a829f.js";import"./chevron-down-e41c1b61.js";function Se(){return"嗨 {{ user.name }}，您的訂單 {{ order.id }} 已出貨，謝謝！"}const te="__mock_line_text_templates__";function y(){try{return JSON.parse(localStorage.getItem(te)||"[]")}catch{return[]}}function P(m){localStorage.setItem(te,JSON.stringify(m))}function v(){return y()}function Te(m){const c=String(m||"").toLowerCase();return y().filter(d=>(d.name||"").toLowerCase().includes(c)||(d.description||"").toLowerCase().includes(c))}function Pe(m){const c=y(),d={id:`LT-${Date.now()}`,name:"",description:"",content:Se(),...m};return c.unshift(d),P(c),d}function $e(m,c){const d=y().map(h=>h.id===m?{...h,...c}:h);P(d)}function Ae(m){const c=y().filter(d=>d.id!==m);P(c)}function Le(m){const c=y(),d=c.find(j=>j.id===m);if(!d)return null;const h={...d,id:`LT-${Date.now()}`,name:`${d.name||"未命名"} (複製)`};return c.unshift(h),P(c),h}const _e=()=>{const m=({text:t="",title:s="Marelle"})=>{const l=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),p=t!=null&&t.trim()?t:"（尚未輸入內容）";return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"w-full max-w-lg rounded-2xl border border-gray-200 overflow-hidden bg-white shadow",children:[e.jsx("div",{className:"bg-[#06c755] text-white px-4 py-2 text-sm font-medium",children:s}),e.jsx("div",{className:"bg-gray-100 p-3 space-y-2 min-h-[360px] max-h-[480px] overflow-y-auto",children:e.jsx("div",{className:"flex items-end gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"inline-block bg-white text-gray-900 px-3 py-2 rounded-2xl rounded-tl-sm shadow whitespace-pre-wrap max-w-[85%]",children:p}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:l})]})})}),e.jsx("div",{className:"bg-white border-t border-gray-200 px-3 py-2 text-gray-400 text-sm",children:"訊息輸入列（預覽）"})]})})},[c,d]=a.useState(""),[h,j]=a.useState(null),[w,b]=a.useState([]),[o,g]=a.useState({name:"",category:"",description:"",tags:[],content:""}),[V,_]=a.useState(!1),R=a.useRef(null),[se,C]=a.useState(!1),[ae,$]=a.useState(!1),[A,L]=a.useState(!1),[k,G]=a.useState(()=>X()),[F,K]=a.useState("default"),[N,ne]=a.useState("preview"),[q,z]=a.useState(!1),[E,J]=a.useState(null),[U,le]=a.useState(Z[0].key),[W,ie]=a.useState(""),M=a.useMemo(()=>we(),[]);a.useMemo(()=>X(),[]);const Y=a.useMemo(()=>{const t=[];Object.entries(M).forEach(([l,p])=>{(p||[]).forEach(x=>{const f=(x.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...x,category:l,path:f})})});const s=Object.fromEntries(t.map(l=>[l.path,l])),r=Object.fromEntries(t.map(l=>[l.token,l]));return{items:t,byPath:s,byToken:r}},[M]),B=a.useMemo(()=>{const t=(o==null?void 0:o.content)||"",s=/\{\{\s*([\w.]+)\s*\}\}/g,r=new Set;let l;for(;l=s.exec(t);)l[1]&&r.add(l[1]);return Array.from(r)},[o==null?void 0:o.content]),S=a.useMemo(()=>B.length?B.map(t=>{const s=Y.byPath[t];if(s)return s;const r=t.split(".")[0];return{label:t,token:`{{${t}}}`,desc:"",category:r,path:t}}):[],[B,Y.byPath]),re=(t,s)=>s.split(".").reduce((r,l)=>r&&r[l]!==void 0?r[l]:"",t),ce=(t,s,r)=>{const l=s.split("."),p=Array.isArray(t)?[...t]:{...t};let x=p;for(let f=0;f<l.length;f++){const u=l[f];if(f===l.length-1)x[u]=r;else{const T=x[u],Ne=T&&typeof T=="object"&&!Array.isArray(T);x[u]=Ne?{...T}:{},x=x[u]}}return p},oe=a.useMemo(()=>{const t=S.length;return N==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[N,S.length]);a.useEffect(()=>{const t=v();b(t),t.length&&j(t[0].id)},[]);const i=a.useMemo(()=>w.find(t=>t.id===h)||null,[w,h]);a.useEffect(()=>{g(i?{name:i.name||"",category:i.category||"",description:i.description||"",tags:Array.isArray(i.tags)?i.tags:[],content:i.content||""}:{name:"",category:"",description:"",tags:[],content:""})},[i]);const H=a.useMemo(()=>c?Te(c):w,[c,w]),de=()=>{const t=Pe({name:"新範本",description:"",content:""}),s=v();b(s),j(t.id)},me=t=>{const s=Le(t),r=v();b(r),s&&j(s.id)},xe=t=>{b(v())},ue=()=>{var s;if(!i)return;Ae(i.id);const t=v();b(t),j(((s=t[0])==null?void 0:s.id)||null),C(!1)},he=()=>{i&&(_(!0),$e(i.id,{...o}),b(v()),_(!1))},pe=[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],ge=[{label:"welcome",value:"welcome"},{label:"member",value:"member"},{label:"order",value:"order"},{label:"logistics",value:"logistics"},{label:"promo",value:"promo"},{label:"cart",value:"cart"},{label:"remarketing",value:"remarketing"}],fe=t=>{const s=R.current;if(!s){g(u=>({...u,content:(u.content||"")+t}));return}const r=s.selectionStart??s.value.length,l=s.selectionEnd??s.value.length,p=o.content.slice(0,r),x=o.content.slice(l),f=`${p}${t}${x}`;g(u=>({...u,content:f})),requestAnimationFrame(()=>{s.focus();const u=r+t.length;s.setSelectionRange(u,u)})},[je,be]=a.useState({recipient:""}),ve=()=>{z(!0),J(null);const t=ee(o.content,k);setTimeout(()=>{z(!1),J({success:!0,message:"測試訊息已模擬送出",rendered:t})},700)},ye=Ce(),O=t=>{G(ke(t))};return a.useEffect(()=>{A&&O(F||"default")},[A]),e.jsxs("div",{className:`${n.pageContainer}`,children:[e.jsxs("div",{className:`${n.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:n.pageTitle,children:"Line 一般訊息"}),e.jsx("p",{className:n.pageSubtitle,children:"集中管理 Line 純文字訊息範本"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:n.secondaryButton,onClick:()=>i&&me(i.id),children:"複製範本"}),e.jsx("button",{className:n.primaryButton,onClick:de,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${n.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、標籤",value:c,onChange:t=>d(t.target.value),className:`${n.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[H.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),H.map(t=>e.jsx("button",{onClick:()=>j(t.id),className:`w-full text-left p-4 transition-colors ${h===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500 line-clamp-1",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${n.glassCard} space-y-6`,children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:n.input,value:o.name,onChange:t=>g(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(I,{options:pe,value:o.category,onChange:t=>g(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:n.input,value:o.description,onChange:t=>g(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(I,{options:ge,value:o.tags,onChange:t=>g(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:n.btnGhost,onClick:()=>$(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:R,className:`${n.input} min-h-[160px]`,value:o.content,onChange:t=>g(s=>({...s,content:t.target.value})),placeholder:"輸入要發送的純文字內容"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",i.updatedAt?new Date(i.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:n.btnSecondary,onClick:()=>C(!0),children:"刪除"}),i.status!=="published"&&e.jsx("button",{className:n.btnGhost,onClick:()=>xe(i.id),children:"發佈"}),e.jsx("button",{className:n.btnGhost,onClick:()=>L(!0),children:"預覽"}),e.jsx("button",{className:`${n.btnPrimary} ${V?"opacity-70 pointer-events-none":""}`,onClick:he,children:V?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(D,{isOpen:se,onClose:()=>C(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",i==null?void 0:i.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:n.secondaryButton,onClick:()=>C(!1),children:"取消"}),e.jsx("button",{className:n.primaryButton,onClick:ue,children:"確定刪除"})]})]})}),e.jsx(D,{isOpen:A,onClose:()=>L(!1),title:"預覽",size:oe,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(Q,{mode:"controlled",activeKey:N,onTabChange:t=>ne(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽與發送"},{key:"context",label:"情境與欄位"}]}),N==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-6",children:e.jsx(m,{text:ee(o.content,k),title:"Marelle"})}),e.jsxs("div",{className:"col-span-6",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"發送測試"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"測試接收者（名稱或 UserId）"}),e.jsx("input",{className:n.input,value:je.recipient,onChange:t=>be(s=>({...s,recipient:t.target.value})),placeholder:"例如：王小明 或 Uxxxxxxxx"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"不會真正送到 LINE，只做本地模擬"}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:`${n.primaryButton} ${q?"opacity-70 pointer-events-none":""}`,onClick:ve,children:q?"傳送中…":"送出測試"})}),E&&e.jsx("div",{className:`${E.success?"text-green-700 bg-green-50":"text-red-700 bg-red-50"} p-3 rounded-lg text-sm`,children:E.message})]})]})]}),N==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(I,{options:ye,value:F,onChange:t=>{K(t),O(t)},placeholder:"選擇情境"})]}),S.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:S.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),r=re(k,t.path),l=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:l}),e.jsx("input",{className:n.input,value:r||"",disabled:s,onChange:p=>{const x=ce(k,t.path,p.target.value);G(x)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:n.secondaryButton,onClick:()=>{K("default"),O("default")},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:n.primaryButton,onClick:()=>L(!1),children:"關閉"})})]})}),e.jsx(D,{isOpen:ae,onClose:()=>$(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(Q,{mode:"controlled",activeKey:U,onTabChange:t=>le(t.key),layout:"left",tabs:Z.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:W,onChange:t=>ie(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${n.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(M[U]||[]).filter(t=>{const s=W.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(r=>r.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsx("button",{className:n.primaryButton,onClick:()=>fe(t.token),children:"插入"})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:n.secondaryButton,onClick:()=>$(!1),children:"完成"})})]})})]})};export{_e as default};
