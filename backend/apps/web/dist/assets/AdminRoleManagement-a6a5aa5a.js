import{R as r,j as s,A as o}from"./index-5be64975.js";import{S as R}from"./StandardTable-046e436b.js";import{G as v}from"./GlassModal-8d9cbd14.js";import"./SearchableSelect-06cd3eb3.js";import{a as M,b as I,g as P,d as E,e as L}from"./index-3a4190b3.js";import{U as $}from"./UsersIcon-99672bc6.js";import{P as A}from"./PlusIcon-86b6a2f5.js";import{X as K}from"./XCircleIcon-81e55d0c.js";import{C as F}from"./CheckCircleIcon-3b5f52cb.js";import"./chevron-down-e41c1b61.js";import"./XMarkIcon-404a829f.js";const p=(d,c)=>s.jsx("span",{className:`inline-flex items-center px-2 py-1 text-xs font-bold rounded font-chinese ${c}`,children:d});function J(){const[d,c]=r.useState([]),[g,y]=r.useState([]),[u,x]=r.useState({}),[G,f]=r.useState(!1),[N,i]=r.useState(!1),[h,b]=r.useState("");r.useEffect(()=>{let e=!0;return(async()=>{f(!0);try{const[a,t]=await Promise.all([M(),I()]);if(!e)return;y((a||[]).map(l=>({key:l.key||l.name,label:l.label||l.key||l.name}))),c(t||[]);const m=(t||[]).map(l=>l.name),n=await Promise.all(m.map(async l=>[l,await P(l)]));e&&x(Object.fromEntries(n))}finally{f(!1)}})(),()=>{e=!1}},[]);const j=[{key:"name",label:"角色",sortable:!0,render:e=>s.jsx("span",{className:"font-chinese font-medium",children:e})},{key:"modulesCount",label:"啟用模組數",sortable:!0,render:(e,a)=>{var t;return((t=u[a.name])==null?void 0:t.length)||0}}],C=e=>e.id||e.name,k=e=>{const a=new Set(u[e.name]||[]);return g.map(t=>({id:`${e.name}-${t.key}`,moduleKey:t.key,moduleLabel:t.label,granted:a.has(t.key),roleName:e.name}))},S=[{key:"moduleLabel",label:"模組",sortable:!0},{key:"granted",label:"可用",sortable:!0,render:(e,a)=>s.jsxs("div",{className:"flex items-center gap-2",children:[e?p("啟用","bg-green-100 text-green-700"):p("停用","bg-gray-100 text-gray-700"),s.jsx("button",{className:`${e?"text-red-600 hover:bg-red-100":"text-green-600 hover:bg-green-100"} p-1 rounded`,onClick:async()=>{const t=u[a.roleName]||[],m=e?t.filter(n=>n!==a.moduleKey):[...new Set([...t,a.moduleKey])];try{await E(a.roleName,m),x(n=>({...n,[a.roleName]:m}))}catch(n){alert((n==null?void 0:n.message)||"更新角色模組失敗")}},children:e?s.jsx(K,{className:"w-4 h-4"}):s.jsx(F,{className:"w-4 h-4"})})]})}],w=async()=>{const e=(h||"").trim();if(e)try{const a=await L(e);c(t=>[{id:a.id,name:e},...t]),x(t=>({...t,[e]:[]})),i(!1),b("")}catch(a){alert((a==null?void 0:a.message)||"新增角色失敗")}};return s.jsx("div",{className:"bg-[#fdf8f2] min-h-screen",children:s.jsxs("div",{className:o.contentContainerFluid,children:[s.jsxs("div",{className:"flex items-center justify-between mb-8",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx($,{className:"w-8 h-8 text-amber-500 mr-3"}),s.jsx("h1",{className:"text-3xl font-bold text-gray-800 font-chinese",children:"角色管理"})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("button",{className:o.btnPrimary,onClick:()=>i(!0),children:s.jsxs("span",{className:"inline-flex items-center",children:[s.jsx(A,{className:"w-5 h-5 mr-2"}),"新增角色"]})})})]}),s.jsx(R,{data:d,columns:j,title:"角色清單",exportFileName:"角色清單",getRowId:C,enableRowExpansion:!0,getSubRows:k,subColumns:S,subtableClassName:"rounded-lg"}),s.jsx(v,{isOpen:N,onClose:()=>i(!1),title:"新增角色",size:"max-w-md",children:s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色名稱"}),s.jsx("input",{className:o.input,value:h,onChange:e=>b(e.target.value),placeholder:"例如：Auditor"})]}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:o.btnSecondary,onClick:()=>i(!1),children:"取消"}),s.jsx("button",{className:o.btnPrimary,onClick:w,children:"建立"})]})]})})]})})}export{J as default};
