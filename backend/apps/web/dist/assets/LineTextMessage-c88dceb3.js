import{r as n,j as e,A as r}from"./index-09c3368c.js";import{G as B}from"./GlassModal-a6c5f610.js";import{T as Q}from"./TabNavigation-8088ee11.js";import{S as D}from"./SearchableSelect-bf34f521.js";import"./XMarkIcon-93d59038.js";import"./chevron-down-5d12351e.js";const X=[{key:"user",label:"使用者"},{key:"order",label:"訂單"},{key:"product",label:"商品"},{key:"payment",label:"付款"},{key:"logistics",label:"物流"},{key:"system",label:"系統"}];function we(){return{user:[{token:"{{user.name}}",label:"使用者名稱"},{token:"{{user.email}}",label:"Email"}],order:[{token:"{{order.id}}",label:"訂單編號"},{token:"{{order.total}}",label:"訂單金額"},{token:"{{order.createdAt}}",label:"下單時間"}],product:[{token:"{{product.title}}",label:"商品名稱"},{token:"{{product.sku}}",label:"SKU"}],payment:[{token:"{{payment.amount}}",label:"付款金額"},{token:"{{payment.method}}",label:"付款方式"}],logistics:[{token:"{{logistics.trackingNo}}",label:"物流編號"},{token:"{{logistics.carrier}}",label:"物流業者"}],system:[{token:"{{system.date}}",label:"日期"},{token:"{{system.time}}",label:"時間"}]}}function Z(){const l=new Date,a=d=>d.toString().padStart(2,"0");return{user:{name:"小明",email:"user@example.com"},order:{id:"O-1001",total:1680,createdAt:`${l.getFullYear()}-${a(l.getMonth()+1)}-${a(l.getDate())}`},product:{title:"優雅白色連衣裙",sku:"SKU-001"},payment:{amount:1680,method:"CreditCard"},logistics:{trackingNo:"T-778899",carrier:"黑貓"},system:{date:`${l.getFullYear()}-${a(l.getMonth()+1)}-${a(l.getDate())}`,time:`${a(l.getHours())}:${a(l.getMinutes())}`}}}function ee(l,a){return String(l||"").replace(/\{\{\s*([\w.]+)\s*\}\}/g,(d,u)=>u.split(".").reduce((p,y)=>p&&p[y],a)??"")}function ke(){return[{key:"order_shipped",label:"出貨通知"},{key:"order_paid",label:"付款成功"}]}function Ce(l){const a={user:{name:"小明"},order:{id:"O-1001"}};return l==="order_shipped"?{...a,logistics:{trackingNo:"T-778899"}}:l==="order_paid"?{...a,payment:{amount:1234}}:a}function Se(){return"嗨 {{ user.name }}，您的訂單 {{ order.id }} 已出貨，謝謝！"}const te="__mock_line_text_templates__";function N(){try{return JSON.parse(localStorage.getItem(te)||"[]")}catch{return[]}}function T(l){localStorage.setItem(te,JSON.stringify(l))}function v(){return N()}function $e(l){const a=String(l||"").toLowerCase();return N().filter(d=>(d.name||"").toLowerCase().includes(a)||(d.description||"").toLowerCase().includes(a))}function Te(l){const a=N(),d={id:`LT-${Date.now()}`,name:"",description:"",content:Se(),...l};return a.unshift(d),T(a),d}function Pe(l,a){const d=N().map(u=>u.id===l?{...u,...a}:u);T(d)}function Ae(l){const a=N().filter(d=>d.id!==l);T(a)}function Le(l){const a=N(),d=a.find(p=>p.id===l);if(!d)return null;const u={...d,id:`LT-${Date.now()}`,name:`${d.name||"未命名"} (複製)`};return a.unshift(u),T(a),u}const Ie=()=>{const l=({text:t="",title:s="Marelle"})=>{const i=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),g=t!=null&&t.trim()?t:"（尚未輸入內容）";return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"w-full max-w-lg rounded-2xl border border-gray-200 overflow-hidden bg-white shadow",children:[e.jsx("div",{className:"bg-[#06c755] text-white px-4 py-2 text-sm font-medium",children:s}),e.jsx("div",{className:"bg-gray-100 p-3 space-y-2 min-h-[360px] max-h-[480px] overflow-y-auto",children:e.jsx("div",{className:"flex items-end gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"inline-block bg-white text-gray-900 px-3 py-2 rounded-2xl rounded-tl-sm shadow whitespace-pre-wrap max-w-[85%]",children:g}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:i})]})})}),e.jsx("div",{className:"bg-white border-t border-gray-200 px-3 py-2 text-gray-400 text-sm",children:"訊息輸入列（預覽）"})]})})},[a,d]=n.useState(""),[u,p]=n.useState(null),[y,j]=n.useState([]),[m,b]=n.useState({name:"",category:"",description:"",tags:[],content:""}),[I,R]=n.useState(!1),V=n.useRef(null),[se,k]=n.useState(!1),[ae,P]=n.useState(!1),[A,L]=n.useState(!1),[C,F]=n.useState(()=>Z()),[G,K]=n.useState("default"),[w,ne]=n.useState("preview"),[U,Y]=n.useState(!1),[E,q]=n.useState(null),[z,le]=n.useState(X[0].key),[J,re]=n.useState(""),M=n.useMemo(()=>we(),[]);n.useMemo(()=>Z(),[]);const W=n.useMemo(()=>{const t=[];Object.entries(M).forEach(([i,g])=>{(g||[]).forEach(x=>{const f=(x.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...x,category:i,path:f})})});const s=Object.fromEntries(t.map(i=>[i.path,i])),o=Object.fromEntries(t.map(i=>[i.token,i]));return{items:t,byPath:s,byToken:o}},[M]),O=n.useMemo(()=>{const t=(m==null?void 0:m.content)||"",s=/\{\{\s*([\w.]+)\s*\}\}/g,o=new Set;let i;for(;i=s.exec(t);)i[1]&&o.add(i[1]);return Array.from(o)},[m==null?void 0:m.content]),S=n.useMemo(()=>O.length?O.map(t=>{const s=W.byPath[t];if(s)return s;const o=t.split(".")[0];return{label:t,token:`{{${t}}}`,desc:"",category:o,path:t}}):[],[O,W.byPath]),ie=(t,s)=>s.split(".").reduce((o,i)=>o&&o[i]!==void 0?o[i]:"",t),ce=(t,s,o)=>{const i=s.split("."),g=Array.isArray(t)?[...t]:{...t};let x=g;for(let f=0;f<i.length;f++){const h=i[f];if(f===i.length-1)x[h]=o;else{const $=x[h],Ne=$&&typeof $=="object"&&!Array.isArray($);x[h]=Ne?{...$}:{},x=x[h]}}return g},oe=n.useMemo(()=>{const t=S.length;return w==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[w,S.length]);n.useEffect(()=>{const t=v();j(t),t.length&&p(t[0].id)},[]);const c=n.useMemo(()=>y.find(t=>t.id===u)||null,[y,u]);n.useEffect(()=>{b(c?{name:c.name||"",category:c.category||"",description:c.description||"",tags:Array.isArray(c.tags)?c.tags:[],content:c.content||""}:{name:"",category:"",description:"",tags:[],content:""})},[c]);const H=n.useMemo(()=>a?$e(a):y,[a,y]),de=()=>{const t=Te({name:"新範本",description:"",content:""}),s=v();j(s),p(t.id)},me=t=>{const s=Le(t),o=v();j(o),s&&p(s.id)},ue=t=>{j(v())},xe=()=>{var s;if(!c)return;Ae(c.id);const t=v();j(t),p(((s=t[0])==null?void 0:s.id)||null),k(!1)},he=()=>{c&&(R(!0),Pe(c.id,{...m}),j(v()),R(!1))},pe=[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],ge=[{label:"welcome",value:"welcome"},{label:"member",value:"member"},{label:"order",value:"order"},{label:"logistics",value:"logistics"},{label:"promo",value:"promo"},{label:"cart",value:"cart"},{label:"remarketing",value:"remarketing"}],be=t=>{const s=V.current;if(!s){b(h=>({...h,content:(h.content||"")+t}));return}const o=s.selectionStart??s.value.length,i=s.selectionEnd??s.value.length,g=m.content.slice(0,o),x=m.content.slice(i),f=`${g}${t}${x}`;b(h=>({...h,content:f})),requestAnimationFrame(()=>{s.focus();const h=o+t.length;s.setSelectionRange(h,h)})},[fe,ye]=n.useState({recipient:""}),je=()=>{Y(!0),q(null);const t=ee(m.content,C);setTimeout(()=>{Y(!1),q({success:!0,message:"測試訊息已模擬送出",rendered:t})},700)},ve=ke(),_=t=>{F(Ce(t))};return n.useEffect(()=>{A&&_(G||"default")},[A]),e.jsxs("div",{className:`${r.pageContainer}`,children:[e.jsxs("div",{className:`${r.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:r.pageTitle,children:"Line 一般訊息"}),e.jsx("p",{className:r.pageSubtitle,children:"集中管理 Line 純文字訊息範本"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:r.secondaryButton,onClick:()=>c&&me(c.id),children:"複製範本"}),e.jsx("button",{className:r.primaryButton,onClick:de,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${r.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、標籤",value:a,onChange:t=>d(t.target.value),className:`${r.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[H.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),H.map(t=>e.jsx("button",{onClick:()=>p(t.id),className:`w-full text-left p-4 transition-colors ${u===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.name}),e.jsx("div",{className:"text-sm text-gray-500 line-clamp-1",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${r.glassCard} space-y-6`,children:c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:r.input,value:m.name,onChange:t=>b(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(D,{options:pe,value:m.category,onChange:t=>b(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:r.input,value:m.description,onChange:t=>b(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(D,{options:ge,value:m.tags,onChange:t=>b(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:r.btnGhost,onClick:()=>P(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:V,className:`${r.input} min-h-[160px]`,value:m.content,onChange:t=>b(s=>({...s,content:t.target.value})),placeholder:"輸入要發送的純文字內容"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",c.updatedAt?new Date(c.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:r.btnSecondary,onClick:()=>k(!0),children:"刪除"}),c.status!=="published"&&e.jsx("button",{className:r.btnGhost,onClick:()=>ue(c.id),children:"發佈"}),e.jsx("button",{className:r.btnGhost,onClick:()=>L(!0),children:"預覽"}),e.jsx("button",{className:`${r.btnPrimary} ${I?"opacity-70 pointer-events-none":""}`,onClick:he,children:I?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(B,{isOpen:se,onClose:()=>k(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",c==null?void 0:c.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:r.secondaryButton,onClick:()=>k(!1),children:"取消"}),e.jsx("button",{className:r.primaryButton,onClick:xe,children:"確定刪除"})]})]})}),e.jsx(B,{isOpen:A,onClose:()=>L(!1),title:"預覽",size:oe,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(Q,{mode:"controlled",activeKey:w,onTabChange:t=>ne(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽與發送"},{key:"context",label:"情境與欄位"}]}),w==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-6",children:e.jsx(l,{text:ee(m.content,C),title:"Marelle"})}),e.jsxs("div",{className:"col-span-6",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"發送測試"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"測試接收者（名稱或 UserId）"}),e.jsx("input",{className:r.input,value:fe.recipient,onChange:t=>ye(s=>({...s,recipient:t.target.value})),placeholder:"例如：王小明 或 Uxxxxxxxx"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"不會真正送到 LINE，只做本地模擬"}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:`${r.primaryButton} ${U?"opacity-70 pointer-events-none":""}`,onClick:je,children:U?"傳送中…":"送出測試"})}),E&&e.jsx("div",{className:`${E.success?"text-green-700 bg-green-50":"text-red-700 bg-red-50"} p-3 rounded-lg text-sm`,children:E.message})]})]})]}),w==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(D,{options:ve,value:G,onChange:t=>{K(t),_(t)},placeholder:"選擇情境"})]}),S.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:S.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),o=ie(C,t.path),i=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:i}),e.jsx("input",{className:r.input,value:o||"",disabled:s,onChange:g=>{const x=ce(C,t.path,g.target.value);F(x)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:r.secondaryButton,onClick:()=>{K("default"),_("default")},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:r.primaryButton,onClick:()=>L(!1),children:"關閉"})})]})}),e.jsx(B,{isOpen:ae,onClose:()=>P(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(Q,{mode:"controlled",activeKey:z,onTabChange:t=>le(t.key),layout:"left",tabs:X.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:J,onChange:t=>re(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${r.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(M[z]||[]).filter(t=>{const s=J.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(o=>o.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsx("button",{className:r.primaryButton,onClick:()=>be(t.token),children:"插入"})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:r.secondaryButton,onClick:()=>P(!1),children:"完成"})})]})})]})};export{Ie as default};
