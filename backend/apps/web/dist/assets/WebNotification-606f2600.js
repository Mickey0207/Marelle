import{r as i,j as e,A as a}from"./index-5be64975.js";import{G as V}from"./GlassModal-8d9cbd14.js";import{T as ee}from"./TabNavigation-b0ee78ba.js";import{S as W}from"./SearchableSelect-06cd3eb3.js";import{r as k,b as be,V as I,g as ge,a as ye,c as ve}from"./presets-f50821a2.js";import"./XMarkIcon-404a829f.js";import"./chevron-down-e41c1b61.js";function je(){return{title:"系統通知：訂單 {{ order.id }} 已出貨",body:"嗨 {{ user.name }}，系統偵測到您的訂單已出貨，物流單號：{{ shipment.tracking }}。",type:"order",severity:"info",source:"訂單系統",ctaLabel:"前往訂單",ctaUrl:"https://marelle.com.tw/orders/{{ order.id }}"}}const te="__mock_web_notification_templates__";function w(){try{return JSON.parse(localStorage.getItem(te)||"[]")}catch{return[]}}function $(l){localStorage.setItem(te,JSON.stringify(l))}function N(){return w()}function fe(l){const o=String(l||"").toLowerCase();return w().filter(m=>(m.name||"").toLowerCase().includes(o)||(m.description||"").toLowerCase().includes(o)||(m.title||"").toLowerCase().includes(o))}function Ne(l){const o=w(),m=je(),h={id:`WN-${Date.now()}`,name:"新站內通知",description:"",category:"",tags:[],...m,...l};return o.unshift(h),$(o),h}function we(l,o){const m=w().map(h=>h.id===l?{...h,...o,updatedAt:Date.now()}:h);$(m)}function Ce(l){const o=w().filter(m=>m.id!==l);$(o)}function ke(l){const o=w(),m=o.find(b=>b.id===l);if(!m)return null;const h={...m,id:`WN-${Date.now()}`,name:`${m.name||"未命名"} (複製)`,updatedAt:Date.now()};return o.unshift(h),$(o),h}function Se(l,o){return{title:k((l==null?void 0:l.title)||"",o),body:k((l==null?void 0:l.body)||"",o),ctaLabel:k((l==null?void 0:l.ctaLabel)||"",o),ctaUrl:k((l==null?void 0:l.ctaUrl)||"",o),type:(l==null?void 0:l.type)||"system",severity:(l==null?void 0:l.severity)||"info",source:k((l==null?void 0:l.source)||"",o)}}const Be=()=>{const l=({item:t})=>{if(!t)return null;const s=(x,p)=>e.jsx("span",{className:`px-2 py-0.5 text-xs rounded-full ${p}`,children:x}),n={order:"訂單",payment:"金流",review:"評價",system:"系統"},d=t.severity==="error"?"bg-red-100 text-red-800":t.severity==="warning"?"bg-amber-100 text-amber-800":t.severity==="success"?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800";return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"w-full max-w-2xl rounded-2xl border border-gray-200 overflow-hidden bg-white shadow",children:[e.jsxs("div",{className:"px-5 py-4 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:t.title||"（無標題）"}),s(n[t.type]||t.type||"一般","bg-gray-100 text-gray-700"),s(t.severity||"info",d)]}),t.source&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:t.source})]}),e.jsxs("div",{className:"p-5 space-y-3",children:[e.jsx("div",{className:"text-gray-800 whitespace-pre-wrap leading-7",children:t.body||"（無內容）"}),t.ctaUrl&&e.jsx("div",{className:"pt-2",children:e.jsx("a",{href:t.ctaUrl,target:"_blank",rel:"noreferrer",className:"inline-block bg-[#cc824d] text-white text-sm px-3 py-2 rounded-lg hover:brightness-110",children:t.ctaLabel||"前往"})})]})]})})},[o,m]=i.useState(""),[h,b]=i.useState(null),[S,g]=i.useState([]),[r,u]=i.useState({name:"",category:"",description:"",tags:[],title:"",body:"",type:"system",severity:"info",source:"",ctaLabel:"",ctaUrl:""}),[K,F]=i.useState(!1),E=i.useRef(null),U=i.useRef(null),B=i.useRef(null),q=i.useRef(null),[se,A]=i.useState(!1),[ae,L]=i.useState(!1),[R,D]=i.useState(!1),[G,z]=i.useState(()=>be()),[J,Y]=i.useState("default"),[C,le]=i.useState("preview"),[M,ne]=i.useState(I[0].key),[H,re]=i.useState(""),O=i.useMemo(()=>ge(),[]),Q=i.useMemo(()=>{const t=[];Object.entries(O).forEach(([n,d])=>{(d||[]).forEach(x=>{const p=(x.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...x,category:n,path:p})})});const s=Object.fromEntries(t.map(n=>[n.path,n]));return{items:t,byPath:s}},[O]),X=i.useMemo(()=>{const t=[r.title||"",r.body||"",r.source||"",r.ctaLabel||"",r.ctaUrl||""],s=/\{\{\s*([\w.]+)\s*\}\}/g,n=new Set;return t.forEach(d=>{let x;for(;x=s.exec(d);)x[1]&&n.add(x[1])}),Array.from(n)},[r]),P=i.useMemo(()=>X.map(t=>Q.byPath[t]||{label:t,token:`{{${t}}}`,desc:"",category:t.split(".")[0],path:t}),[X,Q.byPath]),ce=(t,s)=>s.split(".").reduce((n,d)=>n&&n[d]!==void 0?n[d]:"",t),ie=(t,s,n)=>{const d=s.split("."),x=Array.isArray(t)?[...t]:{...t};let p=x;for(let y=0;y<d.length;y++){const v=d[y];if(y===d.length-1)p[v]=n;else{const j=p[v],f=j&&typeof j=="object"&&!Array.isArray(j);p[v]=f?{...j}:{},p=p[v]}}return x},oe=i.useMemo(()=>{const t=P.length;return C==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[C,P.length]);i.useEffect(()=>{const t=N();g(t),t.length&&b(t[0].id)},[]);const c=i.useMemo(()=>S.find(t=>t.id===h)||null,[S,h]);i.useEffect(()=>{u(c?{name:c.name||"",category:c.category||"",description:c.description||"",tags:Array.isArray(c.tags)?c.tags:[],title:c.title||"",body:c.body||"",type:c.type||"system",severity:c.severity||"info",source:c.source||"",ctaLabel:c.ctaLabel||"",ctaUrl:c.ctaUrl||""}:{name:"",category:"",description:"",tags:[],title:"",body:"",type:"system",severity:"info",source:"",ctaLabel:"",ctaUrl:""})},[c]);const Z=i.useMemo(()=>o?fe(o):S,[o,S]),de=()=>{const t=Ne({name:"新站內通知",description:""}),s=N();g(s),b(t.id)},me=t=>{const s=ke(t),n=N();g(n),s&&b(s.id)},xe=t=>{g(N())},ue=()=>{var s;if(!c)return;Ce(c.id);const t=N();g(t),b(((s=t[0])==null?void 0:s.id)||null),A(!1)},he=()=>{c&&(F(!0),we(c.id,{...r}),g(N()),F(!1))},T=(t,s)=>{const n=t==null?void 0:t.current;if(!n)return;const d=n.selectionStart??n.value.length,x=n.selectionEnd??n.value.length,p=n.value.slice(0,d),y=n.value.slice(x),v=`${p}${s}${y}`,j=n===E.current?"title":n===U.current?"body":n===B.current?"ctaLabel":"ctaUrl";u(f=>({...f,[j]:v})),requestAnimationFrame(()=>{n.focus();const f=d+s.length;n.setSelectionRange(f,f)})},pe=ye(),_=t=>{z(ve(t))};return i.useEffect(()=>{R&&_(J||"default")},[R]),e.jsxs("div",{className:`${a.pageContainer}`,children:[e.jsxs("div",{className:`${a.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:a.pageTitle,children:"網站通知"}),e.jsx("p",{className:a.pageSubtitle,children:"集中管理站內通知（管理員/內部提醒）"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>c&&me(c.id),children:"複製範本"}),e.jsx("button",{className:a.primaryButton,onClick:de,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${a.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、主題、標籤",value:o,onChange:t=>m(t.target.value),className:`${a.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[Z.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),Z.map(t=>e.jsx("button",{onClick:()=>b(t.id),className:`w-full text-left p-4 transition-colors ${h===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese truncate",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.title||"（無標題）"}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${a.glassCard} space-y-6`,children:c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:a.input,value:r.name,onChange:t=>u(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(W,{options:[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],value:r.category,onChange:t=>u(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:a.input,value:r.description,onChange:t=>u(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(W,{options:[{label:"order",value:"order"},{label:"payment",value:"payment"},{label:"review",value:"review"},{label:"system",value:"system"}],value:r.tags,onChange:t=>u(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"標題"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>L(!0),children:"插入變數"})]})]}),e.jsx("input",{ref:E,className:a.input,value:r.title,onChange:t=>u(s=>({...s,title:t.target.value})),placeholder:"輸入站內通知標題"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>L(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:U,className:`${a.input} min-h-[160px]`,value:r.body,onChange:t=>u(s=>({...s,body:t.target.value})),placeholder:"輸入站內通知內容（支援變數）"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"類型"}),e.jsxs("select",{className:a.input,value:r.type,onChange:t=>u(s=>({...s,type:t.target.value})),children:[e.jsx("option",{value:"order",children:"訂單"}),e.jsx("option",{value:"payment",children:"金流"}),e.jsx("option",{value:"review",children:"評價"}),e.jsx("option",{value:"system",children:"系統"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"等級"}),e.jsxs("select",{className:a.input,value:r.severity,onChange:t=>u(s=>({...s,severity:t.target.value})),children:[e.jsx("option",{value:"info",children:"一般"}),e.jsx("option",{value:"success",children:"成功"}),e.jsx("option",{value:"warning",children:"警告"}),e.jsx("option",{value:"error",children:"錯誤"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"來源"}),e.jsx("input",{className:a.input,value:r.source,onChange:t=>u(s=>({...s,source:t.target.value})),placeholder:"例如：訂單系統／金流（ECPay）／系統監控"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"CTA 按鈕文字"}),e.jsx("input",{ref:B,className:a.input,value:r.ctaLabel,onChange:t=>u(s=>({...s,ctaLabel:t.target.value})),placeholder:"例如：前往訂單"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"CTA 連結"}),e.jsx("input",{ref:q,className:a.input,value:r.ctaUrl,onChange:t=>u(s=>({...s,ctaUrl:t.target.value})),placeholder:"https://marelle.com.tw/... 或 /orders/123"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",c.updatedAt?new Date(c.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnSecondary,onClick:()=>A(!0),children:"刪除"}),c.status!=="published"&&e.jsx("button",{className:a.btnGhost,onClick:()=>xe(c.id),children:"發佈"}),e.jsx("button",{className:a.btnGhost,onClick:()=>D(!0),children:"預覽"}),e.jsx("button",{className:`${a.btnPrimary} ${K?"opacity-70 pointer-events-none":""}`,onClick:he,children:K?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(V,{isOpen:se,onClose:()=>A(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",c==null?void 0:c.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>A(!1),children:"取消"}),e.jsx("button",{className:a.primaryButton,onClick:ue,children:"確定刪除"})]})]})}),e.jsx(V,{isOpen:R,onClose:()=>D(!1),title:"預覽",size:oe,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(ee,{mode:"controlled",activeKey:C,onTabChange:t=>le(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽"},{key:"context",label:"情境與欄位"}]}),C==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-7",children:(()=>{const t=Se({title:r.title,body:r.body,ctaLabel:r.ctaLabel,ctaUrl:r.ctaUrl,type:r.type,severity:r.severity,source:r.source},G);return e.jsx(l,{item:t})})()}),e.jsxs("div",{className:"col-span-5",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"通知元資料"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"類型"}),e.jsx("input",{className:a.input,value:r.type,disabled:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"等級"}),e.jsx("input",{className:a.input,value:r.severity,disabled:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"來源"}),e.jsx("input",{className:a.input,value:r.source,disabled:!0})]})]})]})]}),C==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(W,{options:pe,value:J,onChange:t=>{Y(t),_(t)},placeholder:"選擇情境"})]}),P.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:P.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),n=ce(G,t.path),d=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:d}),e.jsx("input",{className:a.input,value:n||"",disabled:s,onChange:x=>{const p=ie(G,t.path,x.target.value);z(p)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>{Y("default"),_("default")},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:a.primaryButton,onClick:()=>D(!1),children:"關閉"})})]})}),e.jsx(V,{isOpen:ae,onClose:()=>L(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(ee,{mode:"controlled",activeKey:M,onTabChange:t=>ne(t.key),layout:"left",tabs:I.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:H,onChange:t=>re(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${a.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(I.find(t=>t.key===M)?O[M]:[]).filter(t=>{const s=H.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(n=>n.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnGhost,onClick:()=>T(E,t.token),children:"插入標題"}),e.jsx("button",{className:a.primaryButton,onClick:()=>T(U,t.token),children:"插入內容"}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(B,t.token),children:"插入 CTA 文"}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(q,t.token),children:"插入 CTA 連結"})]})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>L(!1),children:"完成"})})]})})]})};export{Be as default};
