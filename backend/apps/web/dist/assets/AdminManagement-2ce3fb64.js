import{r as i,R as re,h as ie,v as ce,j as s,A as n,w as oe,x as R,y as de}from"./index-09c3368c.js";import{S as me}from"./StandardTable-d1cd024c.js";import{G as F}from"./GlassModal-a6c5f610.js";import{S as y}from"./SearchableSelect-bf34f521.js";import{I as L}from"./IconActionButton-fd764fa6.js";import{U as ue}from"./UsersIcon-56853008.js";import{P as xe}from"./PlusIcon-3d2e3b30.js";import{P as he}from"./PencilIcon-619ae986.js";import{A as be}from"./AdjustmentsHorizontalIcon-4b269a48.js";import{X as pe}from"./XCircleIcon-20cf1885.js";import{C as fe}from"./CheckCircleIcon-377c1a08.js";import"./chevron-down-5d12351e.js";import"./XMarkIcon-93d59038.js";function ge({title:m,titleId:d,...f},k){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:k,"aria-labelledby":d},f),m?i.createElement("title",{id:d},m):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"}))}const je=i.forwardRef(ge),ye=je,N=(m,d)=>s.jsx("span",{className:`inline-flex items-center px-2 py-1 text-xs font-bold rounded font-chinese ${d}`,children:m}),$e=()=>{const[m,d]=i.useState([]),[f,k]=i.useState(!1),[Ne,$]=i.useState(null),[u,_]=i.useState([]);re.useEffect(()=>{let e=!0;return(async()=>{k(!0);try{const t=await ie();e&&_((t||[]).map(l=>({key:l.name,label:l.name})));const a=await ce();if(!e)return;const c=a.map(l=>{var x;return{id:l.id,username:l.email.split("@")[0],name:l.display_name||l.email,email:l.email,role:((x=l.roles)==null?void 0:x[0])||"Staff",status:"active",lastLogin:"-",modules:Array.isArray(l.modules)?l.modules:[]}});d(c)}catch(t){$((t==null?void 0:t.message)||"載入管理員失敗")}finally{k(!1)}})(),()=>{e=!1}},[]);const I=i.useMemo(()=>{const e=new Set(["全部","Super Admin","Manager","Staff"]);return m.forEach(t=>{t.role&&e.add(t.role)}),Array.from(e)},[m]),[H,O]=i.useState([]),[P,z]=i.useState(""),[S,D]=i.useState("全部"),[C,B]=i.useState("全部"),[T,w]=i.useState(!1),[G,A]=i.useState(!1),[K,E]=i.useState(!1),[b,U]=i.useState(null),X=i.useMemo(()=>m.filter(e=>{const a=`${e.username} ${e.name} ${e.email}`.toLowerCase().includes(P.trim().toLowerCase()),c=S==="全部"||e.role===S,l=C==="全部"||e.status===C;return a&&c&&l}),[m,P,S,C]),W=e=>e.id,Y=(e,t,a)=>{d(c=>c.map(l=>{if(l.id!==e)return l;const x=l.modules.includes(t);return a&&!x?{...l,modules:[...l.modules,t]}:!a&&x?{...l,modules:l.modules.filter(ne=>ne!==t)}:l}))},g=(e,t)=>{d(a=>a.map(c=>c.id===e?{...c,modules:[...new Set(t)]}:c))},Z=[{key:"username",label:"帳號",sortable:!0,render:e=>s.jsx("span",{className:"font-mono",children:e})},{key:"name",label:"姓名",sortable:!0,render:e=>s.jsx("span",{className:"font-chinese font-medium",children:e})},{key:"email",label:"Email",sortable:!0},{key:"role",label:"角色",sortable:!0,render:e=>N(e,{"Super Admin":"bg-purple-100 text-purple-700",Manager:"bg-blue-100 text-blue-700",Staff:"bg-gray-100 text-gray-700"}[e]||"bg-gray-100 text-gray-700")},{key:"status",label:"狀態",sortable:!0,render:e=>e==="active"?N("啟用中","bg-green-100 text-green-700"):N("停用","bg-red-100 text-red-700")},{key:"modules",label:"模組",sortable:!1,render:(e=[])=>{const t=e.slice(0,3),a=e.length-t.length;return s.jsxs("div",{className:"flex items-center flex-wrap gap-1",children:[t.map(c=>{const l=u.find(x=>x.key===c);return s.jsx("span",{className:"px-2 py-0.5 text-xs bg-amber-100 text-amber-700 rounded",children:(l==null?void 0:l.label)||c},c)}),a>0&&s.jsxs("span",{className:"px-2 py-0.5 text-xs bg-gray-100 text-gray-700 rounded",children:["+",a]})]})}},{key:"lastLogin",label:"最後登入",sortable:!0},{key:"actions",label:"操作",sortable:!1,render:(e,t)=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(L,{Icon:he,label:"編輯",variant:"amber",onClick:()=>se(t)}),s.jsx(L,{Icon:be,label:"權限設定",variant:"blue",onClick:()=>ae(t)}),s.jsx(L,{Icon:ye,label:"重設密碼",variant:"gray"})]})}],q=e=>u.map(t=>({id:`${e.id}-${t.key}`,moduleKey:t.key,moduleLabel:t.label,granted:e.modules.includes(t.key)})),J=[{key:"moduleLabel",label:"模組",sortable:!0},{key:"granted",label:"可用",sortable:!0,render:(e,t,a,c)=>s.jsxs("div",{className:"flex items-center gap-2",children:[e?N("啟用","bg-green-100 text-green-700"):N("停用","bg-gray-100 text-gray-700"),s.jsx("button",{className:`${e?"text-red-600 hover:bg-red-100":"text-green-600 hover:bg-green-100"} p-1 rounded`,onClick:()=>Y(c.id,t.moduleKey,!e),children:e?s.jsx(pe,{className:"w-4 h-4"}):s.jsx(fe,{className:"w-4 h-4"})})]})}],Q=e=>s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"text-sm text-gray-700 font-chinese",children:["快速調整「",e.name,"」的模組權限"]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>g(e.id,[]),children:"清除"}),s.jsx("button",{className:n.btnSecondary,onClick:()=>g(e.id,u.map(t=>t.key)),children:"全選"}),s.jsx("button",{className:n.btnPrimary,onClick:()=>g(e.id,v(e.role,u.map(t=>t.key))),children:"依角色預設"})]})]}),V=[{label:"批次啟用",onClick:e=>d(t=>t.map(a=>e.includes(a.id)?{...a,status:"active"}:a))},{label:"批次停用",onClick:e=>d(t=>t.map(a=>e.includes(a.id)?{...a,status:"inactive"}:a))},{label:"批次刪除",variant:"danger",onClick:e=>d(t=>t.filter(a=>!e.includes(a.id)))}],[r,h]=i.useState({username:"",name:"",email:"",password:"",role:"Staff",modules:[]}),ee=async()=>{if(!(!r.username||!r.email||!r.password))try{const e=await oe({email:r.email,password:r.password,display_name:r.name||r.username}),t=(e==null?void 0:e.id)||`u${Date.now()}`;if(r.modules&&r.modules.length>0)try{await R(t,[...new Set(r.modules)])}catch(a){console.warn("apiSetAdminModules failed",a)}d(a=>[{id:t,username:r.username,name:r.name||r.username,email:r.email,role:r.role,status:"active",lastLogin:"-",modules:[...new Set(r.modules)]},...a]),w(!1),h({username:"",name:"",email:"",password:"",role:"Staff",modules:[]})}catch(e){alert((e==null?void 0:e.message)||"建立管理員失敗")}},[o,p]=i.useState({id:"",username:"",name:"",email:"",role:"Staff",status:"active"}),se=e=>{p({id:e.id,username:e.username,name:e.name,email:e.email,role:e.role,status:e.status}),A(!0)},te=async()=>{try{await de(o.id,{display_name:o.name||o.username})}catch(t){alert((t==null?void 0:t.message)||"更新管理員失敗");return}d(t=>t.map(a=>a.id===o.id?{...a,username:o.username,name:o.name,email:o.email,role:o.role,status:o.status}:a));const e=v(o.role,u.map(t=>t.key));e&&g(o.id,e),A(!1)},[M,j]=i.useState([]),ae=e=>{U(e),j(e.modules),E(!0)},le=async()=>{if(b)try{await R(b.id,M),g(b.id,M),E(!1)}catch(e){alert((e==null?void 0:e.message)||"儲存權限失敗")}};return s.jsx("div",{className:"bg-[#fdf8f2] min-h-screen",children:s.jsxs("div",{className:n.contentContainerFluid,children:[s.jsxs("div",{className:"flex items-center justify-between mb-8",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(ue,{className:"w-8 h-8 text-amber-500 mr-3"}),s.jsx("h1",{className:"text-3xl font-bold text-gray-800 font-chinese",children:"管理員管理"})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("button",{className:n.btnPrimary,onClick:()=>w(!0),children:s.jsxs("span",{className:"inline-flex items-center",children:[s.jsx(xe,{className:"w-5 h-5 mr-2"}),"新增管理員"]})})})]}),s.jsx("div",{className:`${n.glassCard} mb-6`,children:s.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"搜尋"}),s.jsx("input",{className:n.input,placeholder:"帳號/姓名/Email",value:P,onChange:e=>z(e.target.value)})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(y,{options:I,value:S,onChange:e=>D(e),placeholder:"選擇角色"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"狀態"}),s.jsx(y,{options:["全部","active","inactive"],value:C,onChange:e=>B(e),placeholder:"選擇狀態"})]})]})}),s.jsx(me,{data:X,columns:Z,title:"管理員清單",exportFileName:"管理員清單",enableBatchSelection:!0,selectedItems:H,onSelectedItemsChange:O,batchActions:V,getRowId:W,enableRowExpansion:!0,getSubRows:e=>q(e),subColumns:J,renderSubtableHeader:Q,subtableClassName:"rounded-lg"}),s.jsx(F,{isOpen:T,onClose:()=>w(!1),title:"新增管理員",size:"max-w-3xl",children:s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"帳號"}),s.jsx("input",{className:n.input,value:r.username,onChange:e=>h(t=>({...t,username:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"姓名"}),s.jsx("input",{className:n.input,value:r.name,onChange:e=>h(t=>({...t,name:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"Email"}),s.jsx("input",{className:n.input,type:"email",value:r.email,onChange:e=>h(t=>({...t,email:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"密碼"}),s.jsx("input",{className:n.input,type:"password",value:r.password,onChange:e=>h(t=>({...t,password:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(y,{options:I.filter(e=>e!=="全部"),value:r.role,onChange:e=>h(t=>({...t,role:e,modules:v(e,u.map(a=>a.key))})),placeholder:"選擇角色"})]})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("h3",{className:"text-lg font-bold font-chinese",children:"模組權限"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>h(e=>({...e,modules:[]})),children:"清除"}),s.jsx("button",{className:n.btnSecondary,onClick:()=>h(e=>({...e,modules:u.map(t=>t.key)})),children:"全選"}),s.jsx("button",{className:n.btnPrimary,onClick:()=>h(e=>({...e,modules:v(e.role,u.map(t=>t.key))})),children:"依角色預設"})]})]}),s.jsx("div",{className:"grid grid-cols-4 gap-2",children:u.map(e=>{const t=r.modules.includes(e.key);return s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:a=>{const c=a.target.checked;h(l=>({...l,modules:c?[...new Set([...l.modules,e.key])]:l.modules.filter(x=>x!==e.key)}))}}),s.jsx("span",{children:e.label})]},e.key)})})]}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>w(!1),children:"取消"}),s.jsx("button",{className:n.btnPrimary,onClick:ee,children:"建立"})]})]})}),s.jsx(F,{isOpen:G,onClose:()=>A(!1),title:"編輯管理員",size:"max-w-2xl",children:s.jsxs("div",{className:"p-6 space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"帳號"}),s.jsx("input",{className:n.input,value:o.username,onChange:e=>p(t=>({...t,username:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"姓名"}),s.jsx("input",{className:n.input,value:o.name,onChange:e=>p(t=>({...t,name:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"Email"}),s.jsx("input",{className:n.input,type:"email",value:o.email,onChange:e=>p(t=>({...t,email:e.target.value}))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"角色"}),s.jsx(y,{options:I.filter(e=>e!=="全部"),value:o.role,onChange:e=>p(t=>({...t,role:e})),placeholder:"選擇角色"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-bold text-gray-700 font-chinese mb-1",children:"狀態"}),s.jsx(y,{options:["active","inactive"],value:o.status,onChange:e=>p(t=>({...t,status:e})),placeholder:"選擇狀態"})]})]}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>A(!1),children:"取消"}),s.jsx("button",{className:n.btnPrimary,onClick:te,children:"儲存"})]})]})}),s.jsx(F,{isOpen:K,onClose:()=>E(!1),title:"權限設定",size:"max-w-3xl",contentMaxHeight:"max-h-[calc(85vh-80px)]",children:s.jsx("div",{className:"p-6 space-y-4",children:b&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"text-sm text-gray-700",children:["為 ",s.jsx("span",{className:"font-bold",children:b.name})," 調整模組權限"]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>j([]),children:"清除"}),s.jsx("button",{className:n.btnSecondary,onClick:()=>j(u.map(e=>e.key)),children:"全選"}),s.jsx("button",{className:n.btnPrimary,onClick:()=>j(v(b.role,u.map(e=>e.key))),children:"依角色預設"})]})]}),s.jsx("div",{className:"grid grid-cols-4 gap-2",children:u.map(e=>{const t=M.includes(e.key);return s.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[s.jsx("input",{type:"checkbox",checked:t,onChange:a=>{const c=a.target.checked;j(l=>c?[...new Set([...l,e.key])]:l.filter(x=>x!==e.key))}}),s.jsx("span",{children:e.label})]},e.key)})}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx("button",{className:n.btnSecondary,onClick:()=>E(!1),children:"取消"}),s.jsx("button",{className:n.btnPrimary,onClick:le,children:"套用"})]})]})})})]})})};function v(m,d){if(!m)return[];const f=String(m).toLowerCase();return f.includes("super")||f.includes("admin")?d:[]}export{$e as default};
