import{r,j as e,A as a}from"./index-5be64975.js";import{G as D}from"./GlassModal-8d9cbd14.js";import{T as se}from"./TabNavigation-b0ee78ba.js";import{S as V}from"./SearchableSelect-06cd3eb3.js";import{r as _,b as ke,V as G,g as Ce,a as Se,c as Te}from"./presets-f50821a2.js";import"./XMarkIcon-404a829f.js";import"./chevron-down-e41c1b61.js";function $e(){return`嗨 {{ user.name }}，您的訂單 {{ order.id }} 已出貨，謝謝！

如有任何問題，歡迎隨時聯繫我們的客服。`}const ne="__mock_mail_text_templates__";function w(){try{return JSON.parse(localStorage.getItem(ne)||"[]")}catch{return[]}}function E(u){localStorage.setItem(ne,JSON.stringify(u))}function N(){return w()}function Pe(u){const o=String(u||"").toLowerCase();return w().filter(d=>(d.name||"").toLowerCase().includes(o)||(d.description||"").toLowerCase().includes(o)||(d.subject||"").toLowerCase().includes(o))}function Ee(u){const o=w(),d={id:`MT-${Date.now()}`,name:"",description:"",category:"",tags:[],subject:"Marelle 通知：訂單 {{ order.id }} 已出貨",content:$e(),headerImageUrl:"",signatureText:`—
Marelle 客服團隊`,signatureImageUrl:"",...u};return o.unshift(d),E(o),d}function Ae(u,o){const d=w().map(h=>h.id===u?{...h,...o,updatedAt:Date.now()}:h);E(d)}function Ie(u){const o=w().filter(d=>d.id!==u);E(o)}function Me(u){const o=w(),d=o.find(j=>j.id===u);if(!d)return null;const h={...d,id:`MT-${Date.now()}`,name:`${d.name||"未命名"} (複製)`,updatedAt:Date.now()};return o.unshift(h),E(o),h}function ae({subject:u,content:o,signatureText:d},h){return{subject:_(u||"",h),content:_(o||"",h),signatureText:_(d||"",h)}}const _e=()=>{const u=({subject:t="",content:s="",headerImageUrl:n="",signatureText:c="",signatureImageUrl:m=""})=>{const x=s!=null&&s.trim()?s:"（尚未輸入內容）";return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"w-full max-w-2xl rounded-2xl border border-gray-200 overflow-hidden bg-white shadow",children:[e.jsx("div",{className:"bg-gray-800 text-white px-4 py-2 text-sm font-medium",children:"Email 預覽"}),e.jsxs("div",{className:"p-0 bg-white",children:[n?e.jsx("img",{src:n,alt:"Header",className:"w-full object-cover max-h-48"}):e.jsx("div",{className:"w-full h-10 bg-gray-100 flex items-center justify-center text-xs text-gray-400",children:"無標頭圖片"}),e.jsxs("div",{className:"px-5 py-4 space-y-3",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-900 break-words",children:t||"（無主旨）"}),e.jsx("div",{className:"h-px bg-gray-200"}),e.jsx("div",{className:"whitespace-pre-wrap text-gray-800 text-[15px] leading-7 break-words",children:x}),(m||c)&&e.jsxs("div",{className:"pt-4 mt-2 border-t border-gray-200",children:[m&&e.jsx("img",{src:m,alt:"Signature",className:"max-h-24 object-contain mb-2"}),c&&e.jsx("div",{className:"text-gray-600 whitespace-pre-wrap text-sm",children:c})]})]})]})]})})},[o,d]=r.useState(""),[h,j]=r.useState(null),[C,b]=r.useState([]),[l,g]=r.useState({name:"",category:"",description:"",tags:[],subject:"",content:"",headerImageUrl:"",signatureText:"",signatureImageUrl:""}),[F,K]=r.useState(!1),W=r.useRef(null),A=r.useRef(null),[le,S]=r.useState(!1),[re,T]=r.useState(!1),[I,M]=r.useState(!1),[$,q]=r.useState(()=>ke()),[z,J]=r.useState("default"),[k,ie]=r.useState("preview"),[Y,H]=r.useState(!1),[U,Q]=r.useState(null),[B,ce]=r.useState(G[0].key),[X,oe]=r.useState(""),L=r.useMemo(()=>Ce(),[]),Z=r.useMemo(()=>{const t=[];Object.entries(L).forEach(([c,m])=>{(m||[]).forEach(x=>{const p=(x.token||"").replace(/\{\{|\}\}/g,"").trim();t.push({...x,category:c,path:p})})});const s=Object.fromEntries(t.map(c=>[c.path,c])),n=Object.fromEntries(t.map(c=>[c.token,c]));return{items:t,byPath:s,byToken:n}},[L]),O=r.useMemo(()=>{const t=(l==null?void 0:l.subject)||"",s=(l==null?void 0:l.content)||"",n=/\{\{\s*([\w.]+)\s*\}\}/g,c=new Set;let m;return[t,s].forEach(x=>{for(;m=n.exec(x);)m[1]&&c.add(m[1])}),Array.from(c)},[l==null?void 0:l.subject,l==null?void 0:l.content]),P=r.useMemo(()=>O.length?O.map(t=>{const s=Z.byPath[t];if(s)return s;const n=t.split(".")[0];return{label:t,token:`{{${t}}}`,desc:"",category:n,path:t}}):[],[O,Z.byPath]),de=(t,s)=>s.split(".").reduce((n,c)=>n&&n[c]!==void 0?n[c]:"",t),me=(t,s,n)=>{const c=s.split("."),m=Array.isArray(t)?[...t]:{...t};let x=m;for(let p=0;p<c.length;p++){const f=c[p];if(p===c.length-1)x[f]=n;else{const v=x[f],y=v&&typeof v=="object"&&!Array.isArray(v);x[f]=y?{...v}:{},x=x[f]}}return m},xe=r.useMemo(()=>{const t=P.length;return k==="preview"?t<=2?"max-w-4xl":t<=8?"max-w-5xl":"max-w-6xl":t===0?"max-w-xl":t<=2?"max-w-2xl":t<=6?"max-w-3xl":t<=10?"max-w-4xl":"max-w-5xl"},[k,P.length]);r.useEffect(()=>{const t=N();b(t),t.length&&j(t[0].id)},[]);const i=r.useMemo(()=>C.find(t=>t.id===h)||null,[C,h]);r.useEffect(()=>{g(i?{name:i.name||"",category:i.category||"",description:i.description||"",tags:Array.isArray(i.tags)?i.tags:[],subject:i.subject||"",content:i.content||"",headerImageUrl:i.headerImageUrl||"",signatureText:i.signatureText||"",signatureImageUrl:i.signatureImageUrl||""}:{name:"",category:"",description:"",tags:[],subject:"",content:"",headerImageUrl:"",signatureText:"",signatureImageUrl:""})},[i]);const ee=r.useMemo(()=>o?Pe(o):C,[o,C]),ue=()=>{const t=Ee({name:"新郵件範本",description:""}),s=N();b(s),j(t.id)},he=t=>{const s=Me(t),n=N();b(n),s&&j(s.id)},ge=t=>{b(N())},pe=()=>{var s;if(!i)return;Ie(i.id);const t=N();b(t),j(((s=t[0])==null?void 0:s.id)||null),S(!1)},je=()=>{i&&(K(!0),Ae(i.id,{...l}),b(N()),K(!1))},be=[{label:"通用",value:"通用"},{label:"會員",value:"會員"},{label:"訂單",value:"訂單"},{label:"行銷",value:"行銷"},{label:"物流",value:"物流"}],fe=[{label:"welcome",value:"welcome"},{label:"member",value:"member"},{label:"order",value:"order"},{label:"logistics",value:"logistics"},{label:"promo",value:"promo"},{label:"cart",value:"cart"},{label:"remarketing",value:"remarketing"}],te=(t,s)=>{const n=t==null?void 0:t.current;if(!n)return;const c=n.selectionStart??n.value.length,m=n.selectionEnd??n.value.length,x=n.value.slice(0,c),p=n.value.slice(m),f=`${x}${s}${p}`,v=n===A.current?"subject":"content";g(y=>({...y,[v]:f})),requestAnimationFrame(()=>{n.focus();const y=c+s.length;n.setSelectionRange(y,y)})},[ve,ye]=r.useState({recipient:"",email:""}),Ne=()=>{H(!0),Q(null);const t=ae({subject:l.subject,content:l.content,signatureText:l.signatureText},$);setTimeout(()=>{H(!1),Q({success:!0,message:"測試郵件已模擬送出",rendered:t})},700)},we=Se(),R=t=>{q(Te(t))};return r.useEffect(()=>{I&&R(z||"default")},[I]),e.jsxs("div",{className:`${a.pageContainer}`,children:[e.jsxs("div",{className:`${a.contentContainer}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:a.pageTitle,children:"Mail 一般訊息"}),e.jsx("p",{className:a.pageSubtitle,children:"集中管理 Email 純文字（可含圖片與簽名）範本"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>i&&he(i.id),children:"複製範本"}),e.jsx("button",{className:a.primaryButton,onClick:ue,children:"新增範本"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:`${a.glassCard} space-y-4`,children:[e.jsx("div",{className:"flex gap-3",children:e.jsx("input",{placeholder:"搜尋名稱、描述、分類、主旨、標籤",value:o,onChange:t=>d(t.target.value),className:`${a.input}`})}),e.jsxs("div",{className:"divide-y divide-gray-200/60 border border-gray-200/60 rounded-xl overflow-hidden bg-white/70 backdrop-blur-sm",children:[ee.length===0&&e.jsx("div",{className:"p-4 text-gray-500",children:"沒有符合的範本"}),ee.map(t=>e.jsx("button",{onClick:()=>j(t.id),className:`w-full text-left p-4 transition-colors ${h===t.id?"bg-[#cc824d]/10":"hover:bg-gray-50/60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese truncate",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.subject||"（無主旨）"}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:t.description||"—"})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.status==="published"?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"}`,children:t.status==="published"?"已發佈":"草稿"})]})},t.id))]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:`${a.glassCard} space-y-6`,children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"範本名稱"}),e.jsx("input",{className:a.input,value:l.name,onChange:t=>g(s=>({...s,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"分類"}),e.jsx(V,{options:be,value:l.category,onChange:t=>g(s=>({...s,category:t})),placeholder:"選擇分類"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"描述"}),e.jsx("input",{className:a.input,value:l.description,onChange:t=>g(s=>({...s,description:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標籤"}),e.jsx(V,{options:fe,value:l.tags,onChange:t=>g(s=>({...s,tags:t})),multiple:!0,placeholder:"新增或選擇標籤"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"主旨"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(!0),children:"插入變數"})]})]}),e.jsx("input",{ref:A,className:a.input,value:l.subject,onChange:t=>g(s=>({...s,subject:t.target.value})),placeholder:"輸入郵件主旨"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2 gap-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese",children:"內容"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:["可用變數：","{{user.name}}",", ","{{order.number}}",", ","{{shipment.tracking}}"]}),e.jsx("button",{className:a.btnGhost,onClick:()=>T(!0),children:"插入變數"})]})]}),e.jsx("textarea",{ref:W,className:`${a.input} min-h-[200px]`,value:l.content,onChange:t=>g(s=>({...s,content:t.target.value})),placeholder:"輸入郵件純文字內容（可換行）"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"標頭圖片 URL（可選）"}),e.jsx("input",{className:a.input,value:l.headerImageUrl,onChange:t=>g(s=>({...s,headerImageUrl:t.target.value})),placeholder:"https://.../header.png"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"簽名圖片 URL（可選）"}),e.jsx("input",{className:a.input,value:l.signatureImageUrl,onChange:t=>g(s=>({...s,signatureImageUrl:t.target.value})),placeholder:"https://.../signature.png"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 font-chinese mb-1",children:"簽名文字（可選）"}),e.jsx("textarea",{className:`${a.input} min-h-[100px]`,value:l.signatureText,onChange:t=>g(s=>({...s,signatureText:t.target.value})),placeholder:"公司名稱、聯絡方式等…"})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["上次修改：",i.updatedAt?new Date(i.updatedAt).toLocaleString():"—"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnSecondary,onClick:()=>S(!0),children:"刪除"}),i.status!=="published"&&e.jsx("button",{className:a.btnGhost,onClick:()=>ge(i.id),children:"發佈"}),e.jsx("button",{className:a.btnGhost,onClick:()=>M(!0),children:"預覽"}),e.jsx("button",{className:`${a.btnPrimary} ${F?"opacity-70 pointer-events-none":""}`,onClick:je,children:F?"儲存中…":"儲存變更"})]})]})]}):e.jsx("div",{className:"text-gray-500",children:"請先在左側選擇或新增一個範本"})})})]})]}),e.jsx(D,{isOpen:le,onClose:()=>S(!1),title:"刪除範本",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsxs("p",{className:"text-gray-600",children:["確定要刪除「",i==null?void 0:i.name,"」嗎？此動作無法復原。"]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{className:a.secondaryButton,onClick:()=>S(!1),children:"取消"}),e.jsx("button",{className:a.primaryButton,onClick:pe,children:"確定刪除"})]})]})}),e.jsx(D,{isOpen:I,onClose:()=>M(!1),title:"預覽",size:xe,children:e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsx(se,{mode:"controlled",activeKey:k,onTabChange:t=>ie(t.key||t.label),layout:"left",className:"px-2",tabs:[{key:"preview",label:"預覽與發送"},{key:"context",label:"情境與欄位"}]}),k==="preview"&&e.jsxs("div",{className:"grid grid-cols-12 gap-6 items-start",children:[e.jsx("div",{className:"col-span-6",children:(()=>{const t=ae({subject:l.subject,content:l.content,signatureText:l.signatureText},$);return e.jsx(u,{subject:t.subject,content:t.content,headerImageUrl:l.headerImageUrl,signatureText:t.signatureText,signatureImageUrl:l.signatureImageUrl})})()}),e.jsxs("div",{className:"col-span-6",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"發送測試"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"測試收件者（Email）"}),e.jsx("input",{className:a.input,value:ve.email,onChange:t=>ye(s=>({...s,email:t.target.value})),placeholder:"name@example.com"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"不會真正寄出 Email，只做本地模擬"}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:`${a.primaryButton} ${Y?"opacity-70 pointer-events-none":""}`,onClick:Ne,children:Y?"傳送中…":"送出測試"})}),U&&e.jsx("div",{className:`${U.success?"text-green-700 bg-green-50":"text-red-700 bg-red-50"} p-3 rounded-lg text-sm`,children:U.message})]})]})]}),k==="context"&&e.jsx("div",{className:"grid grid-cols-12 gap-6 items-start",children:e.jsxs("div",{className:"col-span-12",children:[e.jsx("div",{className:"text-sm text-gray-700 font-medium mb-3",children:"情境與欄位"}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"快速切換情境"}),e.jsx(V,{options:we,value:z,onChange:t=>{J(t),R(t)},placeholder:"選擇情境"})]}),P.length===0?e.jsx("div",{className:"text-xs text-gray-500",children:"此範本未插入任何變數，無需調整欄位。"}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:P.map(t=>{const s=t.category==="system"||t.path.startsWith("system."),n=de($,t.path),c=`${t.label||t.path} ${t.path}`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:c}),e.jsx("input",{className:a.input,value:n||"",disabled:s,onChange:m=>{const x=me($,t.path,m.target.value);q(x)}})]},t.path)})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"更改會即時反映於預覽分頁"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>{J("default"),R("default")},children:"重置"})})]})]})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{className:a.primaryButton,onClick:()=>M(!1),children:"關閉"})})]})}),e.jsx(D,{isOpen:re,onClose:()=>T(!1),title:"插入變數",children:e.jsxs("div",{className:"space-y-4 p-6",children:[e.jsx(se,{mode:"controlled",activeKey:B,onTabChange:t=>ce(t.key),layout:"left",tabs:G.map(t=>({key:t.key,label:t.label})),className:"px-2"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{value:X,onChange:t=>oe(t.target.value),placeholder:"搜尋變數關鍵字…",className:`${a.input}`})}),e.jsx("div",{className:"space-y-3 max-h-80 overflow-y-auto px-1",children:(G.find(t=>t.key===B)?L[B]:[]).filter(t=>{const s=X.trim().toLowerCase();return s?[t.label,t.token,t.desc].filter(Boolean).some(n=>n.toLowerCase().includes(s)):!0}).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-gray-200/80 bg-white/80 hover:bg-gray-50/60 transition",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 font-chinese",children:t.label}),e.jsx("div",{className:"text-xs text-gray-600 truncate font-mono",children:t.token}),t.desc&&e.jsx("div",{className:"text-xs text-gray-400",children:t.desc})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:a.btnGhost,onClick:()=>te(A,t.token),children:"插入主旨"}),e.jsx("button",{className:a.primaryButton,onClick:()=>te(W,t.token),children:"插入內容"})]})]},t.token))}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsx("button",{className:a.secondaryButton,onClick:()=>T(!1),children:"完成"})})]})})]})};export{_e as default};
