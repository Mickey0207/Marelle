import{r as E,j as i,E as y,P as A,T as D,A as h,S as _}from"./index-723f8a3a.js";const u={FIXED_AMOUNT:"fixed_amount",PERCENTAGE:"percentage",FREE_SHIPPING:"free_shipping",BUY_ONE_GET_ONE:"bogo",BUNDLE_DISCOUNT:"bundle_discount",MEMBER_EXCLUSIVE:"member_exclusive",NEW_USER_BONUS:"new_user_bonus",BIRTHDAY_GIFT:"birthday_gift",CASHBACK:"cashback"},c={DRAFT:"draft",ACTIVE:"active",PAUSED:"paused",EXPIRED:"expired",DEPLETED:"depleted",CANCELLED:"cancelled"},d={AVAILABLE:"available",USED:"used",EXPIRED:"expired",RESERVED:"reserved",CANCELLED:"cancelled"},l={MIN_ORDER_AMOUNT:"min_order_amount",MIN_QUANTITY:"min_quantity",MEMBER_LEVEL:"member_level",FIRST_ORDER:"first_order",PRODUCT_CATEGORY:"product_category",BRAND:"brand",DAY_OF_WEEK:"day_of_week",TIME_RANGE:"time_range",LOCATION:"location",PAYMENT_METHOD:"payment_method"},p={ALLOW_ALL:"allow_all",SELECTIVE:"selective",EXCLUSIVE:"exclusive",HIERARCHICAL:"hierarchical"},g={DIRECT_LINK:"direct_link",QR_CODE:"qr_code",SOCIAL_MEDIA:"social_media",REFERRAL_CODE:"referral_code",GROUP_PURCHASE:"group_purchase"};class T{constructor(){this.coupons=[],this.userCoupons=[],this.stackingRules=[],this.shareEvents=[],this.usageHistory=[],this.initializeData()}getCouponList(t={}){const e=s=>{try{const n=new Date(s);return isNaN(n)?"":n.toISOString().slice(0,10)}catch{return""}};return{success:!0,data:this.getAllCoupons(t).map(s=>{var n,r;return{id:s.id,name:s.name,code:s.code,type:s.type,discountValue:((n=s==null?void 0:s.discountConfig)==null?void 0:n.value)??0,status:s.status,usageCount:(s==null?void 0:s.usageCount)??0,validTo:(r=s==null?void 0:s.validity)!=null&&r.endDate?e(s.validity.endDate):""}})}}initializeData(){const t=localStorage.getItem("marelle-coupons"),e=localStorage.getItem("marelle-user-coupons"),a=localStorage.getItem("marelle-stacking-rules");t?this.coupons=JSON.parse(t):this.generateSampleCoupons(),e?this.userCoupons=JSON.parse(e):this.generateSampleUserCoupons(),a?this.stackingRules=JSON.parse(a):this.generateSampleStackingRules()}generateSampleCoupons(){const t=[{id:1,code:"WELCOME2024",name:"新會員歡迎禮",description:"新會員專享首單優惠",type:u.PERCENTAGE,discountConfig:{value:20,maxDiscount:500,minOrderAmount:1e3,calculation:"before_tax"},conditions:[{type:l.FIRST_ORDER,operator:"equals",value:!0,description:"僅限首次購買"},{type:l.MIN_ORDER_AMOUNT,operator:"gte",value:1e3,description:"最低消費1000元"}],limitations:{totalUsageLimit:1e3,perUserLimit:1,dailyLimit:50},validity:{startDate:new Date("2024-01-01"),endDate:new Date("2024-12-31"),validityType:"fixed_period",expiryWarningDays:7},distribution:{autoIssue:!0,targetAudience:"new_users",issueConditions:["registration"]},stackingRules:{priority:1,stackingType:p.SELECTIVE,compatibleTypes:[u.FREE_SHIPPING]},sharingConfig:{isShareable:!0,shareTypes:[g.SOCIAL_MEDIA,g.DIRECT_LINK],shareRewards:{sharerReward:{type:"points",value:100},shareeCReward:{type:"coupon",value:50}}},status:c.ACTIVE,createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:2,code:"SPRING20",name:"春季大促",description:"春季商品8折優惠",type:u.PERCENTAGE,discountConfig:{value:20,minOrderAmount:500,applicableCategories:["skincare","makeup"],calculation:"on_subtotal"},conditions:[{type:l.PRODUCT_CATEGORY,operator:"in",value:["skincare","makeup"],description:"適用於保養和彩妝商品"}],limitations:{totalUsageLimit:5e3,perUserLimit:3,dailyLimit:200},validity:{startDate:new Date("2024-03-01"),endDate:new Date("2024-05-31"),validityType:"fixed_period",expiryWarningDays:7},stackingRules:{priority:2,stackingType:p.ALLOW_ALL,compatibleTypes:[u.FREE_SHIPPING,u.CASHBACK]},sharingConfig:{isShareable:!0,shareTypes:[g.SOCIAL_MEDIA,g.QR_CODE]},status:c.ACTIVE,createdAt:new Date("2024-02-15"),updatedAt:new Date("2024-02-15")},{id:3,code:"FREESHIP99",name:"滿千免運",description:"訂單滿1000元免運費",type:u.FREE_SHIPPING,discountConfig:{value:0,minOrderAmount:1e3,calculation:"on_shipping"},conditions:[{type:l.MIN_ORDER_AMOUNT,operator:"gte",value:1e3,description:"訂單金額滿1000元"}],limitations:{perUserLimit:10,dailyLimit:1e3},validity:{startDate:new Date("2024-01-01"),endDate:new Date("2024-12-31"),validityType:"fixed_period"},stackingRules:{priority:3,stackingType:p.ALLOW_ALL,compatibleTypes:Object.values(u)},status:c.ACTIVE,createdAt:new Date("2024-01-01")},{id:4,code:"BOGO2024",name:"買一送一特惠",description:"指定商品買一送一",type:u.BUY_ONE_GET_ONE,discountConfig:{value:50,applicableProducts:["prod_001","prod_002","prod_003"],calculation:"on_cheapest"},conditions:[{type:l.MIN_QUANTITY,operator:"gte",value:2,description:"至少購買2件指定商品"}],limitations:{totalUsageLimit:500,perUserLimit:2},validity:{startDate:new Date("2024-06-01"),endDate:new Date("2024-06-30"),validityType:"fixed_period"},stackingRules:{priority:4,stackingType:p.EXCLUSIVE},status:c.ACTIVE,createdAt:new Date("2024-05-15")},{id:5,code:"VIP100",name:"VIP會員專享",description:"VIP會員100元折扣券",type:u.FIXED_AMOUNT,discountConfig:{value:100,minOrderAmount:800,calculation:"on_total"},conditions:[{type:l.MEMBER_LEVEL,operator:"gte",value:"vip",description:"僅限VIP會員使用"}],limitations:{perUserLimit:5,dailyLimit:100},validity:{validityType:"permanent"},stackingRules:{priority:5,stackingType:p.SELECTIVE,compatibleTypes:[u.FREE_SHIPPING]},status:c.ACTIVE,createdAt:new Date("2024-01-01")}];this.coupons=t,this.saveToStorage()}generateSampleUserCoupons(){const t=[];["user_001","user_002","user_003","user_004","user_005"].forEach((a,s)=>{this.coupons.forEach((n,r)=>{if(Math.random()>.3){const o={id:`uc_${s}_${r}`,userId:a,couponId:n.id,couponCode:n.code,status:this.getRandomStatus(),obtainedAt:this.getRandomDate(new Date("2024-01-01"),new Date),expiresAt:this.getRandomExpiryDate(),source:this.getRandomSource(),shareToken:Math.random()>.7?this.generateShareToken():null};o.status===d.USED&&(o.usedAt=this.getRandomDate(o.obtainedAt,new Date),o.orderId=`order_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o.discountAmount=this.calculateRandomDiscount(n)),t.push(o)}})}),this.userCoupons=t}generateSampleStackingRules(){const t=[{id:1,name:"新用戶專屬疊加",priority:1,stackingType:p.SELECTIVE,compatibleTypes:[u.PERCENTAGE,u.FREE_SHIPPING],incompatibleTypes:[u.BUY_ONE_GET_ONE],maxStackCount:2,conditions:[{field:"user.isNew",operator:"equals",value:!0}],calculationOrder:"percentage_first",isActive:!0},{id:2,name:"一般疊加規則",priority:2,stackingType:p.ALLOW_ALL,compatibleTypes:Object.values(u),incompatibleTypes:[],maxStackCount:3,calculationOrder:"best_for_customer",isActive:!0},{id:3,name:"互斥規則",priority:3,stackingType:p.EXCLUSIVE,compatibleTypes:[u.BUY_ONE_GET_ONE],incompatibleTypes:Object.values(u).filter(e=>e!==u.BUY_ONE_GET_ONE),maxStackCount:1,isActive:!0}];this.stackingRules=t}createCoupon(t){try{const e={id:Date.now(),...t,createdAt:new Date,updatedAt:new Date};return this.coupons.push(e),this.saveToStorage(),{success:!0,coupon:e}}catch(e){return{success:!1,error:e.message}}}getAllCoupons(t={}){let e=[...this.coupons];if(t.status&&(e=e.filter(a=>a.status===t.status)),t.type&&(e=e.filter(a=>a.type===t.type)),t.search){const a=t.search.toLowerCase();e=e.filter(s=>s.name.toLowerCase().includes(a)||s.code.toLowerCase().includes(a)||s.description.toLowerCase().includes(a))}if(t.startDate&&t.endDate){const a=new Date(t.startDate),s=new Date(t.endDate);e=e.filter(n=>{const r=new Date(n.validity.startDate);return r>=a&&r<=s})}return t.sortBy&&e.sort((a,s)=>{const n=this.getNestedValue(a,t.sortBy),r=this.getNestedValue(s,t.sortBy);return t.sortOrder==="desc"?r>n?1:-1:n>r?1:-1}),e}getCouponById(t){return this.coupons.find(e=>e.id===parseInt(t))}updateCoupon(t,e){try{const a=this.coupons.findIndex(s=>s.id===parseInt(t));return a===-1?{success:!1,error:"優惠券不存在"}:(this.coupons[a]={...this.coupons[a],...e,updatedAt:new Date},this.saveToStorage(),{success:!0,coupon:this.coupons[a]})}catch(a){return{success:!1,error:a.message}}}deleteCoupon(t){try{const e=this.coupons.findIndex(a=>a.id===parseInt(t));return e===-1?{success:!1,error:"優惠券不存在"}:(this.coupons.splice(e,1),this.saveToStorage(),{success:!0})}catch(e){return{success:!1,error:e.message}}}getUserCoupons(t,e={}){let a=this.userCoupons.filter(s=>s.userId===t);return e.status&&(a=a.filter(s=>s.status===e.status)),a.map(s=>({...s,coupon:this.getCouponById(s.couponId)}))}issueCouponToUser(t,e,a="manual"){try{const s=this.getCouponById(e);if(!s)return{success:!1,error:"優惠券不存在"};if(s.status!==c.ACTIVE)return{success:!1,error:"優惠券未啟用"};const n=this.userCoupons.filter(o=>o.userId===t&&o.couponId===e).length;if(s.limitations.perUserLimit&&n>=s.limitations.perUserLimit)return{success:!1,error:"已達到個人使用上限"};const r={id:`uc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:t,couponId:e,couponCode:s.code,status:d.AVAILABLE,obtainedAt:new Date,expiresAt:this.calculateExpiryDate(s),source:a};return this.userCoupons.push(r),this.saveToStorage(),{success:!0,userCoupon:r}}catch(s){return{success:!1,error:s.message}}}async calculateStackedDiscount(t,e){try{const a=this.validateCoupons(t,e),s=this.groupCompatibleCoupons(a),r=this.generateStackingCombinations(s).map(C=>this.calculateCombinationDiscount(C,e)),o=this.selectBestCombination(r);return{appliedCoupons:o.coupons,totalDiscount:o.totalDiscount,discountBreakdown:o.breakdown,savingsComparison:this.compareSavings(r),warnings:o.warnings||[]}}catch(a){return{appliedCoupons:[],totalDiscount:0,discountBreakdown:[],warnings:[a.message]}}}validateCoupons(t,e){return t.filter(a=>{const s=this.getCouponById(a.couponId);return!s||s.status!==c.ACTIVE||a.status!==d.AVAILABLE||new Date(a.expiresAt)<new Date?!1:this.checkConditions(s.conditions,e)})}checkConditions(t,e){return!t||t.length===0?!0:t.every(a=>{switch(a.type){case l.MIN_ORDER_AMOUNT:return e.subtotal>=a.value;case l.MIN_QUANTITY:return e.totalQuantity>=a.value;case l.PRODUCT_CATEGORY:return e.items.some(s=>a.value.includes(s.category));default:return!0}})}generateShareLink(t,e,a){var s;try{const n=this.getCouponById(e);if(!n||!((s=n.sharingConfig)!=null&&s.isShareable))throw new Error("此優惠券不支援分享");const r=this.generateShareToken(),o={id:`share_${Date.now()}`,userId:t,couponId:e,shareType:a,shareToken:r,shareLink:`${window.location.origin}/coupon/shared/${r}`,clicksCount:0,conversionsCount:0,status:"active",expiresAt:this.calculateShareExpiry(30),createdAt:new Date};return this.shareEvents.push(o),this.saveToStorage(),{success:!0,shareLink:o.shareLink,qrCode:this.generateQRCodeData(o.shareLink),expiresAt:o.expiresAt}}catch(n){return{success:!1,error:n.message}}}getCouponStatistics(t={}){const e={total:this.coupons.length,active:this.coupons.filter(a=>a.status===c.ACTIVE).length,expired:this.coupons.filter(a=>a.status===c.EXPIRED).length,paused:this.coupons.filter(a=>a.status===c.PAUSED).length,totalIssued:this.userCoupons.length,totalUsed:this.userCoupons.filter(a=>a.status===d.USED).length,totalExpired:this.userCoupons.filter(a=>a.status===d.EXPIRED).length,usageRate:0,totalDiscount:0,totalShares:this.shareEvents.length,totalClicks:this.shareEvents.reduce((a,s)=>a+s.clicksCount,0)};return e.usageRate=e.totalIssued>0?e.totalUsed/e.totalIssued*100:0,e.totalDiscount=this.userCoupons.filter(a=>a.status===d.USED&&a.discountAmount).reduce((a,s)=>a+s.discountAmount,0),e}getRandomStatus(){const t=Object.values(d),e=[.6,.2,.1,.05,.05],a=Math.random();let s=0;for(let n=0;n<t.length;n++)if(s+=e[n],a<=s)return t[n];return d.AVAILABLE}getRandomDate(t,e){return new Date(t.getTime()+Math.random()*(e.getTime()-t.getTime()))}getRandomExpiryDate(){const t=new Date,e=new Date(t);return e.setDate(t.getDate()+Math.floor(Math.random()*90)+30),e}getRandomSource(){const t=["manual","auto_issue","shared","redeemed","promotion"];return t[Math.floor(Math.random()*t.length)]}generateShareToken(){return`share_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}calculateRandomDiscount(t){return t.type===u.PERCENTAGE?Math.floor(Math.random()*200)+50:t.type===u.FIXED_AMOUNT?t.discountConfig.value:0}calculateExpiryDate(t){if(t.validity.validityType==="relative_days"){const a=new Date;return a.setDate(a.getDate()+(t.validity.validityDays||30)),a}else if(t.validity.endDate)return new Date(t.validity.endDate);const e=new Date;return e.setDate(e.getDate()+30),e}calculateShareExpiry(t){const e=new Date;return e.setDate(e.getDate()+t),e}generateQRCodeData(t){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAA..."}getNestedValue(t,e){return e.split(".").reduce((a,s)=>a&&a[s],t)}saveToStorage(){localStorage.setItem("marelle-coupons",JSON.stringify(this.coupons)),localStorage.setItem("marelle-user-coupons",JSON.stringify(this.userCoupons)),localStorage.setItem("marelle-stacking-rules",JSON.stringify(this.stackingRules)),localStorage.setItem("marelle-share-events",JSON.stringify(this.shareEvents))}batchUpdateCoupons(t,e){try{const a=[];return t.forEach(s=>{const n=this.coupons.findIndex(r=>r.id===parseInt(s));n!==-1&&(this.coupons[n]={...this.coupons[n],...e,updatedAt:new Date},a.push(this.coupons[n]))}),this.saveToStorage(),{success:!0,updatedCoupons:a}}catch(a){return{success:!1,error:a.message}}}batchDeleteCoupons(t){try{return this.coupons=this.coupons.filter(e=>!t.includes(e.id)),this.saveToStorage(),{success:!0}}catch(e){return{success:!1,error:e.message}}}}const I=new T,f=()=>{const m=E.useMemo(()=>{const{data:s}=I.getCouponList();return s||[]},[]),t=s=>{const n={active:"bg-green-100 text-green-800",expired:"bg-red-100 text-red-800",inactive:"bg-gray-100 text-gray-800"},r={active:"啟用中",expired:"已過期",inactive:"停用"};return i.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${n[s]}`,children:r[s]})},e=s=>({percentage:"百分比折扣",fixed_amount:"固定金額",free_shipping:"免運費"})[s]||s,a=E.useMemo(()=>[{key:"name",label:"名稱",render:(s,n)=>i.jsxs("div",{children:[i.jsx("div",{className:"text-sm font-medium text-gray-900",children:n.name}),i.jsx("div",{className:"text-xs text-gray-500",children:n.code})]})},{key:"type",label:"類型",render:s=>i.jsx("span",{children:e(s)})},{key:"discount",label:"折扣",render:(s,n)=>i.jsx("span",{className:"text-gray-900",children:n.type==="percentage"?`${n.discountValue}%`:n.type==="free_shipping"?"免運費":`NT$ ${n.discountValue}`})},{key:"status",label:"狀態",render:s=>t(s)},{key:"usageCount",label:"使用次數"},{key:"validTo",label:"有效期限"},{key:"actions",label:"操作",render:()=>i.jsxs("div",{className:"flex items-center justify-start space-x-2",children:[i.jsx("button",{className:"p-2 text-gray-400 hover:text-[#cc824d] transition-colors",title:"查看",children:i.jsx(y,{className:"w-4 h-4"})}),i.jsx("button",{className:"p-2 text-gray-400 hover:text-[#cc824d] transition-colors",title:"編輯",children:i.jsx(A,{className:"w-4 h-4"})}),i.jsx("button",{className:"p-2 text-gray-400 hover:text-red-600 transition-colors",title:"刪除",children:i.jsx(D,{className:"w-4 h-4"})})]})}],[]);return i.jsx("div",{className:h.pageContainer,children:i.jsxs("div",{className:h.contentContainerFluid,children:[i.jsxs("div",{className:"mb-6",children:[i.jsx("h1",{className:h.pageTitle,children:"優惠券管理"}),i.jsx("p",{className:h.pageSubtitle,children:"使用表格檢視所有優惠券資料"})]}),i.jsx(_,{data:m,columns:a,title:"優惠券清單",exportFileName:"優惠券清單"})]})})};export{f as default};
